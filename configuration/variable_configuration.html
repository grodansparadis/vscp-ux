<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8" />
    <title>Variable Configuration</title>

    <!-- Don't cache the page -->
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="-1" />

    <script type="text/javascript" src="../js/md5.js"></script>
    <script type="text/javascript" src="../js/vscp.js"></script>
    <script type="text/javascript" src="http://code.jquery.com/jquery-1.11.3.min.js"></script>
    <script type="text/javascript">
        /*jshint bitwise: false */

        // VSCP websocket connection
        var vscpConn = null;
        
        // VSCP variable
        var Variable = function( options ) {
            
            this.name = "";
            this.type = "";
            this.value = "";
            this.persistency = false;
            
            if ( "undefined" !== typeof options ) {
                if ( "string" === typeof options.name ) {
                    this.name = options.name;
                }
                if ( "string" === typeof options.type ) {
                    this.type = options.type;
                }
                if ( "string" === typeof options.value ) {
                    this.value = options.value;
                }
                if ( "boolean" === typeof options.persistency ) {
                    this.persistency = options.persistency;
                }
            }
        };
        
        // Variables
        var variables = [];
        
        // User interface data
        var ui = {
            
            enable: function() {
                $( "#ui :input" ).attr( "disabled", false );
            },
            
            disable: function() {
                $( "#ui :input" ).attr( "disabled", true );
            }
        };

        // Wait until the whole website is loaded, until connection to the VSCP server
        $( document ).ready( function() {

            // Create a VSCP websocket
            vscpConn = new vscp.Connection();

            // Connect to VSCP server
            vscpConn.connect({

                url: "ws://104.236.235.81:8080",

                userName: "admin",

                password: "d50c3180375c27927c22e42a379c3f67",

                onSuccess: function( conn ) {

                    // Enable the user interface
                    ui.enable();
                },

                onError: function( conn ) {

                    // Disable the user interface
                    ui.disable();

                    alert("Connection lost. Please reload website.");
                }
            });
            
            update( 'configuration' );
        });

        // Update the configuration, which is shown the user
        function update( id ) {
        
            var head    = "";
            var body    = "";
            var footer  = "";
            var index   = 0;
            var size    = 0;
        
            // Head
            head += '<table border="1" cellspacing="1" cellpadding="10">';
            head += '    <thead>';
            head += '        <tr>';
            head += '            <th>Id</th>';
            head += '            <th>Name</th>';
            head += '            <th>Type</th>';
            head += '            <th>Value</th>';
            head += '            <th>Persistency</th>';
            head += '            <th></th>';
            head += '        </tr>';
            head += '    </thead>';
            head += '    <tbody>';
        
            // Body
            for( index = 0; index < variables.length; ++index ) {
                body += '<tr>';
                body += '<td>' + index + '</td>';
                body += '<td>' + variables[ index ].name + '</td>';
                body += '<td>' + vscp.constants.varTypeNames[ parseInt( variables[ index ].type ) ] + '</td>';
                
                if ( 20 < variables[ index ].value.length ) {
                    size = variables[ index ].value.length;
                }
                else {
                    size = 20;
                }
                
                body += '<td><input id="input' + index + '" type="text" value="' + variables[ index ].value + '"size="' + size + '" /></td>';
                body += '<td>' + variables[ index ].persistency + '</td>';
                body += '<td>';
                body += '<input type="button" value="Read" onclick="readVariable( \'' + variables[ index ].name + '\', \'input' + index + '\' )" />';
                body += '<input type="button" value="Write" onclick="writeVariable( \'' + variables[ index ].name + '\', \'input' + index + '\' )" />';
                body += '<input type="button" value="Reset" onclick="resetVariable( \'' + variables[ index ].name + '\', \'input' + index + '\' )" />';
                body += '<input type="button" value="Remove" onclick="removeVariable( \'' + variables[ index ].name + '\' )" />';
                body += '<input type="button" value="Get length" onclick="getVariableLength( \'' + variables[ index ].name + '\' )" />';
                body += '<input type="button" value="Get last changed" onclick="getVariableLastChanged( \'' + variables[ index ].name + '\' )" />';
                body += '</td>'
                body += '</tr>';
            }
        
            // Footer
            footer += '    </tbody>';
            footer += '</table>';
        
            // Update now at once
            $("#" + id).html('<p>' + head + body + footer + '</p>');
        }
        
        // Read all variables from server
        function readAllVariables() {

            // Disable user interface
            ui.disable();
        
            // Request all variables from the VSCP server
            vscpConn.listVar({
            
                onVariable: function( conn, variable ) {
            
                    // Store the variable
                    variables.push(
                        new Variable({
                            name: variable.name,
                            type: variable.type,
                            value: variable.value,
                            persistency: variable.persistency
                        })
                    );
                    
                    // Show current configuration to the user
                    update( 'configuration' );
                },
                
                onSuccess: function( conn ) {
                
                    // Clear all variables
                    variables = [];
                    
                    // Enable the user interface
                    ui.enable();
                },
                
                onError: function( conn ) {
                    alert( "Failed to list all variables." );
                    
                    // Enable the user interface
                    ui.enable();
                }
            });
        }
        
        // Write a variable value
        function writeVariable( name, id ) {

            var index = 0;
        
            // Get new value
            var value = $( '#' + id ).val()
        
            // Disable user interface
            ui.disable();
            
            // Write variable value
            vscpConn.writeVar({
                name: name,
                value: value,
                onSuccess: function( conn, options ) {
                                               
                    // Find variable and set the value
                    for( index = 0; index < variables.length; ++index ) {
                        if ( options.name === variables[ index ].name ) {
                            variables[ index ].value = options.value;
                            break;
                        }
                    }
                    
                    // Show the current value now to the user
                    $( '#' + id ).val( options.value );
                    
                    // Invalid value written?
                    if ( value !== options.value ) {
                        alert( "Invalid value: " + value );
                    }
                    // Successful written?
                    else {
                        alert( options.name + " successful written." );
                    }
                                                
                    // Enable user interface
                    ui.enable();
                },
                onError: function( conn ) {
                    alert( "Failed to write " + name + "." );
                    
                    // Enable user interface
                    ui.enable();
                }
            });
        }
        
        // Read a variable value
        function readVariable( name, id ) {

            var index = 0;
                
            // Disable user interface
            ui.disable();
            
            // Read variable value
            vscpConn.readVar({
                name: name,
                onSuccess: function( conn, options ) {
                                               
                    // Find variable and set the value
                    for( index = 0; index < variables.length; ++index ) {
                        if ( options.name === variables[ index ].name ) {
                            variables[ index ].value = options.value;
                            break;
                        }
                    }
                    
                    // Show the current value now to the user
                    $( '#' + id ).val( options.value );
                    
                    alert( options.name + " successful read." );
                    
                    // Enable user interface
                    ui.enable();
                },
                onError: function( conn ) {
                    alert( "Failed to read " + name + "." );
                    
                    // Enable user interface
                    ui.enable();
                }
            });
        }
        
        // Reset a variable
        function resetVariable( name, id ) {

            var index = 0;
                
            // Disable user interface
            ui.disable();
            
            // Reset variable value
            vscpConn.resetVar({
                name: name,
                onSuccess: function( conn, options ) {
                                               
                    // Find variable and set the value
                    for( index = 0; index < variables.length; ++index ) {
                        if ( options.name === variables[ index ].name ) {
                            variables[ index ].value = options.value;
                            break;
                        }
                    }
                    
                    // Show the current value now to the user
                    $( '#' + id ).val( options.value );
                    
                    alert( options.name + " successful reset." );
                    
                    // Enable user interface
                    ui.enable();
                },
                onError: function( conn ) {
                    alert( "Failed to reset " + name + "." );
                    
                    // Enable user interface
                    ui.enable();
                }
            });
        }
        
        // Remove a variable
        function removeVariable( name ) {

            var index = 0;
                
            // Disable user interface
            ui.disable();
            
            // Reset variable value
            vscpConn.removeVar({
                name: name,
                onSuccess: function( conn, options ) {
                                               
                    // Find variable and remove it
                    for( index = 0; index < variables.length; ++index ) {
                        if ( options.name === variables[ index ].name ) {
                            variables.splice( index, 1 );
                            break;
                        }
                    }
                                        
                    alert( options.name + " successful removed." );
                    
                    update( 'configuration' );
                    
                    // Enable user interface
                    ui.enable();
                },
                onError: function( conn ) {
                    alert( "Failed to remove " + name + "." );
                    
                    // Enable user interface
                    ui.enable();
                }
            });
        }
        
        // Get variable length
        function getVariableLength( name ) {

            // Disable user interface
            ui.disable();
            
            // Get variable length
            vscpConn.lengthVar({
                name: name,
                onSuccess: function( conn, options ) {
                                                                                       
                    alert( name + " length is " + options.length + "." );
                    
                    // Enable user interface
                    ui.enable();
                },
                onError: function( conn ) {
                    alert( "Failed to get length of " + name + "." );
                    
                    // Enable user interface
                    ui.enable();
                }
            });
        }
        
        // Get variable last changed
        function getVariableLastChanged( name ) {

            // Disable user interface
            ui.disable();
            
            // Get variable last changed
            vscpConn.lastChangeVar({
                name: name,
                onSuccess: function( conn, options ) {
                                                                                       
                    alert( name + " was last changed " + options.lastChange + "." );
                    
                    // Enable user interface
                    ui.enable();
                },
                onError: function( conn ) {
                    alert( "Failed to get last changed of " + name + "." );
                    
                    // Enable user interface
                    ui.enable();
                }
            });
        }
        
        // Save persistent variables
        function savePersistentVariables( name ) {

            // Disable user interface
            ui.disable();
            
            // Get variable last changed
            vscpConn.saveVar({
                onSuccess: function( conn, options ) {
                                                                                       
                    alert( "All persistent variables saved successful." );
                    
                    // Enable user interface
                    ui.enable();
                },
                onError: function( conn ) {
                    alert( "Failed to save all persistent variables." );
                    
                    // Enable user interface
                    ui.enable();
                }
            });
        }
        
    </script>
</head>
<body>
    <h1>Variable Configuration</h1>
    <div id="ui">
        <input type="submit" value="Read all variables" onclick="readAllVariables()" disabled /><br />
        <input type="submit" value="Save persistent variables" onclick="savePersistentVariables()" disabled /><br />
    </div>
    <div id="configuration">
    </div>
</body>
</html>
