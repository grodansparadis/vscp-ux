<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8" />
    <title>DM STD Configuration</title>

    <!-- Don't cache the page -->
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="-1" />

    <script type="text/javascript" src="../js/md5.js"></script>
    <script type="text/javascript" src="../js/vscp.js"></script>
    <script type="text/javascript" src="../js/vscpRegister.js"></script>
    <script type="text/javascript" src="http://code.jquery.com/jquery-1.11.3.min.js"></script>
    <script type="text/javascript">
        /*jshint bitwise: false */

        // VSCP websocket connection
        var vscpConn = null;
        
        // Standard decision matrix row
        var DMStdRow = function( options ) {
            
            this.oAddr = 0;
            this.flags = 0;
            this.classMask = 0;
            this.classFilter = 0;
            this.typeMask = 0;
            this.typeFilter = 0;
            this.action = 0;
            this.actionParameter = 0;
                                    
            if ( "undefined" !== typeof options ) {
                if ( "number" === typeof options.oAddr ) {
                    this.oAddr = options.oAddr;
                }
                if ( "number" === typeof options.flags ) {
                    this.flags = options.flags;
                }
                if ( "number" === typeof options.classMask ) {
                    this.classMask = options.classMask;
                }
                if ( "number" === typeof options.classFilter ) {
                    this.classFilter = options.classFilter;
                }
                if ( "number" === typeof options.typeMask ) {
                    this.typeMask = options.typeMask;
                }
                if ( "number" === typeof options.typeFilter ) {
                    this.typeFilter = options.typeFilter;
                }
                if ( "number" === typeof options.action ) {
                    this.action = options.action;
                }
                if ( "number" === typeof options.actionParameter ) {
                    this.actionParameter = options.actionParameter;
                }
            }
            
            this.toArray = function() {
                var data = [
                    this.oAddr,
                    this.flags,
                    this.classMask,
                    this.classFilter,
                    this.typeMask,
                    this.typeFilter,
                    this.action,
                    this.actionParameter
                ];
                
                return data;
            };
        };
        
        // Standard decision matrix
        var dmStd = [];
        
        // User interface data
        var ui = {

            getNodeId: function() {
                return parseInt( $( "#nodeId" ).val() );
            },

            getPage: function() {
                return parseInt( $( "#page" ).val() );
            },

            getOffset: function() {
                return parseInt( $("#offset").val() );
            },

            getNumberOfRows: function() {
                return parseInt( $("#numberOfRows").val() );
            },
            
            enable: function() {
                $( "#ui :input" ).attr( "disabled", false );
            },
            
            disable: function() {
                $( "#ui :input" ).attr( "disabled", true );
            }
        };

        // Wait until the whole website is loaded, until connection to the VSCP server
        $( document ).ready( function() {

            // Create a VSCP websocket
            vscpConn = new vscp.Connection();

            // Connect to VSCP server
            vscpConn.connect({

                url: "ws://104.236.235.81:8080",

                userName: "admin",

                password: "d50c3180375c27927c22e42a379c3f67",

                onSuccess: function( conn ) {

                    // Set filter for CLASS1.Protocol
                    vscpConn.setFilter({
                        filterClass: 0x0000,
                        maskClass: 0xffff,
                        filterType: 0x0000,
                        maskType: 0x0000
                    });

                    // Start receiving VSCP events
                    vscpConn.start({
                        onSuccess: function( conn ) {
                            
                            // Enable the user interface
                            ui.enable();
                        },
                        onError: function( conn ) {
                            alert("Couldn't start receiving events.");
                        }
                    });
                },

                onError: function( conn ) {
                    alert("Connection lost. Please reload website.");
                }
            });

            update( "configuration" );
        });

        // Update the configuration, which is shown the user
        function update( id ) {
            var head        = "";
            var body        = "";
            var footer      = "";
            var rowIndex    = 0;
            
            // Head
            head += '<table border="1" cellspacing="1" cellpadding="10">';
            head += '    <thead>';
            head += '        <tr>';
            head += '            <th>Number</th>';
            head += '            <th>Origination address</th>';
            head += '            <th>Class mask</th>';
            head += '            <th>Class filter</th>';
            head += '            <th>Type mask</th>';
            head += '            <th>Type filter</th>';
            head += '            <th>Action</th>';
            head += '            <th>Action parameter</th>';
            head += '        </tr>';
            head += '    </thead>';
            head += '    <tbody>';
            
            //Body

            // Print the rows
            for(rowIndex = 0; rowIndex < dmStd.length; ++rowIndex) {
                body += '        <tr>';
                body += '            <td>' + (rowIndex + 1) + '</td>';
                body += '            <td>';
                body += '                <input type="number" value="' + dmStd[ rowIndex ].oAddr + '" min="0" max="255" onchange="dmStd[ ' + rowIndex + ' ].oAddr = this.value;" />';
                body += '            </td>';
                body += '            <td>';
                body += '                <input type="number" value="' + dmStd[ rowIndex ].classMask + '" min="0" max="255" onchange="dmStd[ ' + rowIndex + ' ].classMask = this.value;" />';
                body += '            </td>';
                body += '            <td>';
                body += '                <input type="number" value="' + dmStd[ rowIndex ].classFilter + '" min="0" max="255" onchange="dmStd[ ' + rowIndex + ' ].classFilter = this.value;" />';
                body += '            </td>';
                body += '            <td>';
                body += '                <input type="number" value="' + dmStd[ rowIndex ].typeMask + '" min="0" max="255" onchange="dmStd[ ' + rowIndex + ' ].typeMask = this.value;" />';
                body += '            </td>';
                body += '            <td>';
                body += '                <input type="number" value="' + dmStd[ rowIndex ].typeFilter + '" min="0" max="255" onchange="dmStd[ ' + rowIndex + ' ].typeFilter = this.value;" />';
                body += '            </td>';
                body += '            <td>';
                body += '                <input type="number" value="' + dmStd[ rowIndex ].action + '" min="0" max="255" onchange="dmStd[ ' + rowIndex + ' ].action = this.value;" />';
                body += '            </td>';
                body += '            <td>';
                body += '                <input type="number" value="' + dmStd[ rowIndex ].actionParameter + '" min="0" max="255" onchange="dmStd[ ' + rowIndex + ' ].actionParameter = this.value;" />';
                body += '            </td>';
                body += '        </tr>';
            }

            // Footer
            footer += '    </tbody>';
            footer += '</table>';

            // Update now at once
            $( "#" + id ).html( '<p>' + head + body + footer + '</p>' );
        }
        
        // Read configuration from node
        function readConfigFromNode() {

            var size = ui.getNumberOfRows() * 8;
        
            if ( ( 0 === size ) || ( 256 < size ) ) {
                return;
            }
            
            // Disable the user interface
            ui.disable();
            
            vscp.register.read({
                
                connection: vscpConn,
                
                nodeId: ui.getNodeId(),
                
                page: ui.getPage(),
                
                offset: ui.getOffset(),
                
                count: size,
                
                onSuccess: function( data ) {
                
                    var index       = 0;
                    var rowIndex    = 0;
                    var rowPart     = 0;
                    
                    // Clear decision matrix
                    dmStd = [];
                    
                    for( index = 0; index < data.length; ++index ) {
                    
                        rowIndex = Math.floor( index / 8 ); // Integer division!
                        rowPart  = index % 8;
                    
                        if ( 0 === rowPart ) {
                        
                            dmStd.push( new DMStdRow() );
                            dmStd[ rowIndex ].oAddr = data[ index ];
                        }
                        else if ( 1 === rowPart ) {
                            dmStd[ rowIndex ].flags = data[ index ];
                        }
                        else if ( 2 === rowPart ) {
                            dmStd[ rowIndex ].classMask = data[ index ];
                        }
                        else if ( 3 === rowPart ) {
                            dmStd[ rowIndex ].classFilter = data[ index ];
                        }
                        else if ( 4 === rowPart ) {
                            dmStd[ rowIndex ].typeMask = data[ index ];
                        }
                        else if ( 5 === rowPart ) {
                            dmStd[ rowIndex ].typeFilter = data[ index ];
                        }
                        else if ( 6 === rowPart ) {
                            dmStd[ rowIndex ].action = data[ index ];
                        }
                        else if ( 7 === rowPart ) {
                            dmStd[ rowIndex ].actionParameter = data[ index ];
                        }
                    
                    }
                    
                    update( 'configuration' );
                
                    // Enable the user interface
                    ui.enable();
                },
                
                onError: function() {
                
                    // Enable the user interface
                    ui.enable();
                }
            });
        }

        // Write configuration to node
        function writeConfigToNode() {

            var index   = 0;
            var data    = [];
        
            if ( 0 === dmStd.length ) {
                return;
            }
            
            // Disable the user interface
            ui.disable();
            
            // Concatenate all decision matrix rows to a byte stream
            for( index = 0; index < dmStd.length; ++index ) {
                data = data.concat( dmStd[ index ].toArray() );
            }
            
            vscp.register.write({
                
                connection: vscpConn,
                
                nodeId: ui.getNodeId(),
                
                page: ui.getPage(),
                
                offset: ui.getOffset(),
                
                data: data,
                
                onSuccess: function() {
                
                    // Enable the user interface
                    ui.enable();
                },
                
                onError: function() {
                
                    // Enable the user interface
                    ui.enable();
                }
            });
        }

    </script>
</head>
<body>
    <h1>Decision Matrix (standard) Configuration</h1>
    <div id="ui">
        <table style="border: 0px">
            <tr>
                <td>Node id:</td>
                <td><input id="nodeId" type="number" value="1" min="0" max="255" disabled /></td>
            </tr>
            <tr>
                <td>Page:</td>
                <td><input id="page" type="number" value="0" min="0" max="65535" disabled /></td>
            </tr>
            <tr>
                <td>Offset:</td>
                <td><input id="offset" type="number" value="0" min="0" max="255" disabled /></td>
            </tr>
            <tr>
                <td>Number of rows:</td>
                <td><input id="numberOfRows" type="number" value="10" min="1" max="32" disabled /></td>
            </tr>
        </table>
        <input type="submit" value="Read configuration from node" onclick="readConfigFromNode()" disabled /><br />
        <input type="submit" value="Write configuration to node" onclick="writeConfigToNode()" disabled /><br />
    </div>
    <div id="configuration">
    </div>
</body>
</html>
