<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>VSCP vscpws_variable demo</title>

    <!-- Don't cache the page -->
    <META HTTP-EQUIV="Pragma" CONTENT="no-cache">
    <META HTTP-EQUIV="Expires" CONTENT="-1">

    <!-- JQuery -->
    <script type="text/javascript" src="../js/jquery/1.11.3/jquery-1.11.3.min.js"></script>
    
    <!-- Bootstrap -->
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="../js/bootstrap/3.3.5/css/bootstrap.min.css">
    <script type="text/javascript" src="../js/bootstrap/3.3.5/js/bootstrap.min.js"></script>

    <!-- Favorite icon -->
    <link rel="icon" href="../favicon.ico">

    <!-- VSCP settings -->
    <script type="text/javascript" src="../js/settings.js"></script>
    <!-- VSCP hash calculation -->
    <script type="text/javascript" src="../js/md5.js"></script>
    <!-- VSCP websocket base library -->
    <script type="text/javascript" src="../js/vscp.js"></script>

    <!-- Boostrap navigation bar helper functions -->
    <script type="text/javascript" src="../js/navBar.js"></script>
    <!-- Navigation bar menu structure -->
    <script type="text/javascript" src="menu.js"></script>

    <script type="text/javascript" >

            // VSCP websocket connection
            var vscpConn = null;

           // Wait until the whole website is loaded
            $( document ).ready( function() {

                // Show navigation bar menu
                navBarMenu.show( "menu", navBarMenu.content );

                // Create a VSCP websocket
                vscpConn = new vscp.Connection();

                // Connect to VSCP server
                vscpConn.connect({

                    url: settings.url,
                    userName: settings.user,
                    password: settings.password,
                    authdomain: settings.authdomain, 

                    onSuccess: function( conn ) {

                        // Start receiving VSCP events
                        vscpConn.start({

                            onSuccess: function( conn ) {
                                // Enable the user interface
                                ui.enable();
                            },

                            onError: function( conn ) {
                                alert("Couldn't start receiving events.");
                            }

                        });

                    },

                    onError: function( conn ) {
                        alert("Couldn't establish a connection or connection lost.");
                    }

                });
            });

            // User interface data
            var ui = {

                enable: function() {
                    $( "#ui :input" ).attr( "disabled", false );
                },

                disable: function() {
                    $( "#ui :input" ).attr( "disabled", true );
                }
            };
            
            // Delete <num> rows in table by tableID
            function stripRows( tableID, num ) {
                try {
                    var table       = document.getElementById( tableID );
                    var rowCount    = table.rows.length;

                    if ( rowCount > num ) {
                        for(var i=0; i<rowCount-num; i++) {
                            table.deleteRow(i);
                        }
                    }
                }
                catch(e) {
                    alert(e);
                }
            }

            var zone = 1;
            var subzone = 20;
            var bMonitorActive = false;

            var createVariable = function() {

                ui.disable();

                vscpConn.createVar({

                    name:           "demovariable",
                    type:           vscp.constants.varTypes.BOOLEAN,    // Optional, defaults to 
                    accessrights:   0x777,                              // Optional, defaults to 744
                    value:          "true",                             // Optional. defaults to empty
                    note:           "This is a simple variable.",       // Optional. default to empty
                    persistency:    false,                              // defaults to false (non-persistent)


                    onSuccess: function( conn ) {
                        $("#mystatus").text("'demovariable' successfully created.");
                        ui.enable();
                    },

                    onError: function( conn ) {
                        $("#mystatus").text("Failed to create 'demovariable'.");
                        ui.enable();
                    }
                });

            };

            var setVariableTrue = function() {

                ui.disable();

                vscpConn.writeVar({

                    name:   "demovariable",
                    value:  "true",

                    onSuccess: function( conn ) {
                        $("#mystatus").text("'demovariable' value successfully set to 'true'.");
                        ui.enable();
                    },

                    onError: function( conn ) {
                        $("#mystatus").text("Failed to set 'demovariable' value to 'true'.");
                        ui.enable();
                    }
                });

            };

            var setVariableFalse = function() {

                ui.disable();

                vscpConn.writeVar({

                    name:   "demovariable",
                    value:  "false",

                    onSuccess: function( conn ) {
                        $("#mystatus").text("'demovariable' value successfully set to 'false'.");
                        ui.enable();
                    },

                    onError: function( conn ) {
                        $("#mystatus").text("Failed to set 'demovariable' value to 'false'.");
                        ui.enable();
                    }
                });

            };

            var resetVariable = function() {

                ui.disable();

                vscpConn.resetVar({

                    name: "demovariable",

                    onSuccess: function( conn ) {
                        $("#mystatus").text("'demovariable' value successfully resetted (set to 'false').");
                        ui.enable();
                    },

                    onError: function( conn ) {
                        $("#mystatus").text("Failed to reset 'demovariable'.");
                        ui.enable();
                    }
                });

            };

            var removeVariable = function() {

                ui.disable();

                vscpConn.removeVar({

                    name: "demovariable",

                    onSuccess: function( conn ) {
                        $("#mystatus").text("'demovariable' was successfully removed.");
                        ui.enable();
                    },

                    onError: function( conn ) {
                        $("#mystatus").text("Failed to remove 'demovariable'.");
                        ui.enable();
                    }
                });

            };

            var lengthVariable = function() {

                ui.disable();

                vscpConn.lengthVar({

                    name: "demovariable",

                    onSuccess: function( conn, options ) {
                        $("#mystatus").text("Length for 'demovariable' is :" + options.length );
                        ui.enable();
                    },

                    onError: function( conn ) {
                        $("#mystatus").text("Failed to get length for 'demovariable'.");
                        ui.enable();
                    }
                });

            };

            var lastchangeVariable = function() {

                ui.disable();

                vscpConn.lastChangeVar({

                    name: "demovariable",

                    onSuccess: function( conn, options ) {
                        $("#mystatus").text( options.name + " was last changed " + options.lastChange + "." );                        
                        ui.enable();
                    },

                    onError: function( conn ) {
                        $("#mystatus").text("Failed to get last change time/date for 'demovariable'.");
                        ui.enable();
                    }
                });

            };

            var listVariable = function() {

                ui.disable();

                var localregex = $("#myRegExp").val();
                
                
                $("#myVariables tr").remove();
                $( "#myVariables" ).append( "<tr><th><b>" + "Name" + 
                                                        "</b></th><th>" + "Type" + 
                                                        "</th><th>" + "UserID" + 
                                                        "</th><th>" + "AccessRight" + 
                                                        "</th><th>" + "Last change" + 
                                                        "</th><th>" + "Persistent" + 
                                                        "</th></tr>" ); 

                vscpConn.listVar({

                    regex: $("#myRegExp").val(),

                    onVariable: function( conn, variable ) {
                        //alert( variable.name + ", " +  variable.type + ", " + variable.persistency );
                        $( "#myVariables" ).append( "<tr><td><b>" + variable.name + 
                                                        "</b></td><td>" + variable.type + 
                                                        "</td><td>" + variable.userid + 
                                                        "</td><td>" + variable.accessright.toString(16) + 
                                                        "</td><td>" + variable.lastchange + 
                                                        "</td><td>" + variable.persistency + "</td></tr>" );
                    },

                    onSuccess: function( conn ) {
                        ui.enable();
                    },

                    onError: function( conn ) {
                        ui.enable();
                    }
                });

            };

            var saveVariable = function() {

                ui.disable();

                vscpConn.saveVar({

                    onSuccess: function( conn ) {
                        ui.enable();
                    },

                    onError: function( conn ) {
                        ui.enable();
                    }
                });

            };

            var intervalId = 0;

            var monitorVariable = function( bMonitor ) {

                if ( true === bMonitor ) {
                    intervalId = setInterval(
                        function () {
                            vscpConn.readVar({
                                name: "demovariable",
                                onSuccess: function( conn, options ) {
                                    $("#mystatus").text( "value = " + options.value );
                                    if ( "true" === options.value ) {                                        
                                        document.body.style.backgroundColor = "#00FF00";
                                        //$("#mystatus").body.style.backgroundColor = "#00FF00";
                                    }
                                    else {
                                        document.body.style.backgroundColor = "#FF0000";
                                        //$("#mystatus").body.style.backgroundColor = "#FF0000";
                                    }
                                }
                            });
                        },
                        1000
                    );

                    document.getElementById("btnMonitor").value = "Stop to monitor variable";
                }
                else {
                    clearInterval( intervalId );
                    document.getElementById("btnMonitor").value = "Start to monitor variable"
                }

                bMonitorActive = bMonitor;

                document.body.style.backgroundColor = "#FFFFFF";
            };

    </script>

</head>

<body>
   <nav class="navbar navbar-inverse">
        <div class="container-fluid">
            <div class="navbar-header">
                <a class="navbar-brand" href="../index.html"><img src="../images/logo/vscp_new.png" class="img-thumbnail" width="100" alt="vscp logo" /></a>
            </div>
            <div id="menu">
            </div>
        </div>
    </nav>
    <div class="container-fluid">
        <h1>VSCP remote variables</h1>
        <p>
            The VSCP Dameon have variables that can be defined/written/read/manipulated by external devices.
            For example can a temperature value be stores in a node and in that way be persistent over time,
            Another possibility is that a variable holds the mean value for a temperature over time or a state of
            something. Remote variables are a very powerful tool.
        </p>
        <p>
            The vscp websocket library makes handling variables from Javascript very easy. You just tell which
            variable you are interested in and then you will get info when this variable has changed.
        </p>
        <p>
            In this demo we just monitor the boolean variable <b>demovariable</b> and show information when
            it's value has changed. You can add a variable, either in code as we do here, or by adding it in the 
            VSCP daemon administrative interface or adding it in the REST or the TCP/IP interfaces.
        </p>
        <p>
            There is also another way to add it. You can add it to the <b>variable.xml</b> file and restart the 
            VSCP daemon. Info on how to add variabes here is in the file that comes with the distribution.
        </p>
        <p>
            There are also <a href="http://www.vscp.org/docs/vscpd/doku.php?id=decision_matrix_varaibles#stock_variables">stock variables</a> 
            defined which hold system and similar information. You can read all about variables 
            <a href="http://www.vscp.org/docs/vscpd/doku.php?id=decision_matrix_varaibles">here.</a>
        </p>
        <p>
            You can also create the variable ("DEMOVARIABLE") by clicking this button
        </p>
        <div id="ui">
            <p>
            <input type="button" class="btn btn-primary" value="Create variable" onclick="createVariable();" disabled />
            </p>
            <p>
            Variables is created if they are written to but is non existing so all this button does is to write
            the value <b>true</b> to the variable with name <i>demovariable</i>.
            </p>
            <p>
            <input type="button" class="btn btn-primary" value="Set variable value to 'true' (writeVariable)" onclick="setVariableTrue()" disabled />
            <input type="button" class="btn btn-primary" value="Set variable value to 'false' (writeVariable)" onclick="setVariableFalse()" disabled />
            <input type="button" class="btn btn-primary" value="Reset variable" onclick="resetVariable()" disabled />
            </p>
            <p>
            <input type="button" class="btn btn-primary" value="Remove variable" onclick="removeVariable()" disabled />
            <input type="button" class="btn btn-primary" value="Get variable length" onclick="lengthVariable()" disabled />
            <input type="button" class="btn btn-primary" value="Get date/time for last change" onclick="lastchangeVariable()" disabled />
            </p>
            <p>
            <input type="button" class="btn btn-primary" value="List all variables" onclick="listVariable()" disabled />
            Optional <a href="http://marvin.cs.uidaho.edu/Handouts/regex.html">regular expression</a> to select variables:  <input id="myRegExp" type="text">
            </p>
            <p>
            <input type="button" class="btn btn-primary" value="Save variables" onclick="saveVariable()" disabled />
            </p>
            <p>
            Now when you have the <i>"demovariable"</i> variable defined you can start to monitor the variables value by clicking this button.
            </p>
            <input id="btnMonitor" type="button" class="btn btn-primary" value="Start to monitor variable" onclick="monitorVariable(!bMonitorActive)" />
        </div>
        <br />
        <pre><div id="mystatus"> </div></pre>    
        <br />        

        <div>
            <h3>Variables</h3>
            <table id="myVariables" class="table table-striped"></table>
        </div>
            
        <br /><br />
        <hr>
        Copyright &copy; 2000-2017 <a href="http://www.grodansparadis.com">Grodans Paradis AB (Paradise of the Frog)</a>
    </div>
</body>
</html>
