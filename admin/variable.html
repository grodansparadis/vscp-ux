<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>VSCP admin interface - Variable maintenance</title>

    <!-- Don't cache the page -->
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="-1" />

    <!-- JQuery -->
    <script type="text/javascript" src="../js/jquery/2.2.1/jquery-2.2.1.min.js"></script>

    
    <!-- Bootstrap -->
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="../js/bootstrap/3.3.7/css/bootstrap.min.css"> 
    <script type="text/javascript" src="../js/bootstrap/3.3.7/js/bootstrap.min.js"></script>

    <!-- Data tables -->
    <link rel="stylesheet" href="../js/datatables/datatables.min.css">
    <script type="text/javascript" src="../js/datatables/datatables.min.js"></script>
    
    <!-- Bootstrap dialogs -->
    <link rel="stylesheet" href="../js/bootstrap3-dialog/1.34.6/css/bootstrap-dialog.min.css">
    <script type="text/javascript" src="../js/bootstrap3-dialog/1.34.6/js/bootstrap-dialog.min.js"></script>
    
    <!-- Bootstrap waitingfor dialog -->
    <script type="text/javascript" src="../js/waitingfor.js"></script>

    <!-- Favorite icon -->
    <link rel="icon" href="favicon.ico">

    

    <!-- VSCP settings -->
    <script type="text/javascript" src="../js/settings.js"></script>
    <!-- VSCP hash calculation -->
    <script type="text/javascript" src="../js/md5.js"></script>
    <!-- VSCP websocket bases library -->
    <script type="text/javascript" src="../js/vscp.js"></script>
    <!-- VSCP admin library -->
    <script type="text/javascript" src="../js/vscpadmin.js"></script>

    <!-- Menu styles -->
    <link rel="stylesheet" type="text/css" href="css/menu.css">
    
    <!-- Boostrap navigation bar helper functions -->
    <script type="text/javascript" src="../js/navBar.js"></script>
    <!-- Navigation bar menu structure -->
    <script type="text/javascript" src="js/menu.js"></script>

    <link rel="stylesheet" type="text/css" href="css/vscp-admin.css">

    <script type="text/javascript">

        var table = null;

        // VSCP websocket connection
        var vscpConn = null;

        ///////////////////////////////////////////////////////////////////////////////////////////
        // load ready
        //
        // Wait until the whole website is loaded
        $( document ).ready( function() {
                
            // Show navigation bar menu
            navBarMenu.show( "menu", navBarMenu.content );

            //vscp.admin.setCopyright();
            vscp.admin.setStatus( "<b>Server:</b> no server selected.", false );   

            if ( typeof( Storage ) !== "undefined" ) {
                // Server
                if ( null != localStorage.getItem("vscp-url") ) {                    
                    settings.url = localStorage.getItem("vscp-url");
                }

                vscp.admin.setStatus( settings.url, false );

                // User
                if ( null != localStorage.getItem("vscp-user") ) {
                    settings.user = localStorage.getItem("vscp-user");
                }
                // Password
                if ( null != localStorage.getItem("vscp-password") ) {
                    settings.password = localStorage.getItem("vscp-password");
                }
                // AuthDomain
                if ( null != localStorage.getItem("vscp-authdomain") ) {
                    settings.authdomain = localStorage.getItem("vscp-authdomain");
                }
            } 
            else {
                // No Web Storage support.
                vscp.admin.setStatus( settings.url, false );
            }   

            table = $('#variableTable').DataTable( {
 
                columns: [
                    { title: "Name" },
                    { title: "Type" },
                    { title: "Persistent" },
                    { title: "Owner" },
                    { title: "Permission" },
                    { title: "lastchange" },
                    {
                        data: null,
                        width : "5%",
                        //defaultContent: '<a href="#" class="remove">Delete</a> <a href="#" class="edit">Edit</a>',
                        defaultContent: '<a href="javascript:void(0)" class="editor_edit" onclick="editDialog();"><span class="glyphicon glyphicon-edit"/></a> <a href="javascript:void(0)" class="editor_remove" onclick="editDialog();" ><span class="glyphicon glyphicon-remove"/></a>',
                        orderable: false
                    },
                ]
            });
 
            // Double click row
            $('#variableTable tbody').on( 'dblclick', 'tr', function () {
 
                var data = table.row( this ).data();
 
                //console.log("Double click");
                //self.Editor.edit( this );
                if ( $(this).hasClass('selected') ) {
                    $(this).removeClass('selected');
                }
                else {
                    table.$('tr.selected').removeClass('selected');
                    $(this).addClass('selected');
                }

                editDialog( data );
                
            });

            // Click row
            $('#variableTable tbody').on( 'click', 'tr', function () {
                var data = table.row( this ).data();
                console.log( 'You clicked on '+ data[0] + '\'s row' );
                
                if ( $(this).hasClass('selected') ) {
                    $(this).removeClass('selected');
                }
                else {
                    table.$('tr.selected').removeClass('selected');
                    $(this).addClass('selected');
                }

                document.getElementById("idVariableValue").innerHTML = 'You clicked on ' + data[0] + '\'s row';

                vscpConn.readVar({

                    name: data[0],

                    onSuccess: function( conn, msg ) {
                        ui.enable();
                        document.getElementById("idVariableValue").innerHTML = vscp.decodeValue( msg.type, msg.value );
                        document.getElementById("idVariableNote").innerHTML = vscp.b64DecodeUnicode( msg.note ); 
                    },

                    onError: function( conn ) {
                        ui.enable();
                        document.getElementById("idVariableValue").innerHTML = "Failed to fetch value";
                        document.getElementById("idVariableNote").innerHTML = "";
                    }
                });

            });
 
            $('#button').click( function () {
                table.row('.selected').remove().draw( false );
             });             

            if ( typeof( Storage ) !== "undefined" ) {

                // Server
                if ( null != localStorage.getItem("vscp-url") ) {                    
                    settings.url = localStorage.getItem("vscp-url");
                }

                vscp.admin.setStatus( settings.url, false );

                // User
                if ( null != localStorage.getItem("vscp-user") ) {
                    settings.user = localStorage.getItem("vscp-user");
                }
                // Password
                if ( null != localStorage.getItem("vscp-password") ) {
                    settings.password = localStorage.getItem("vscp-password");
                }
                // AuthDoamin
                if ( null != localStorage.getItem("vscp-token") ) {
                    settings.token = localStorage.getItem("vscp-token");
                }
            } 
            else {
                // No Web Storage support.
                setConnectInfo( settings.url, false );
            }

            // Create a VSCP websocket
            vscpConn = new vscp.Connection();

            // Connect to VSCP server
            vscpConn.connect({

                url: settings.url,
                userName: settings.user,
                password: settings.password,
                authdomain: settings.authdomain, 

                onSuccess: function( conn ) {

                    // Start receiving VSCP events
                    vscpConn.start({

                        onSuccess: function( conn ) {
                            // Enable the user interface
                            ui.enable();
                        },

                        onError: function( conn ) {
                            alert("Couldn't start receiving events.");
                        }

                    });

                },

                onError: function( conn ) {
                    alert("Couldn't establish a connection or connection lost.");
                }

            });

            /*
            for ( i=0; i<100; i++ ) {
                table.row.add( [
                        "testvar" + i, "Integer", "true", "admin", "777", "2016-11-02 15:49:01"
                ] ).draw( true );
            }
            */

        });

        
        ///////////////////////////////////////////////////////////////////////////////////////////
        // showProgressDialog
        //

        /*function showProgressDialog() 
        {
            //$('#modal-url').val( localStorage.getItem( "vscp-url" ) );
            //$('#dlgProgress').modal();
        };*/

        ///////////////////////////////////////////////////////////////////////////////////////////
        // editDialog
        //
        // Show modal to select active server to use.
        //

        function editDialog( data ) 
        {
            //$('#modal-url').val( localStorage.getItem( "vscp-url" ) );
            $('#dlgedit_varname').val( data[ 0 ] );
            $('#dlgedit_vartype').val( data[ 1 ] );
            $('#modal-brememberme').val( "false" );
            $('#dlgedit_varpersistance').checked = false;
            //document.getElementById("dlgedit_varname").innerHTML = "<b>Variable name:</b> "  + data[ 0 ];
            document.getElementById("dlgedit_vartype").innerHTML = "<b>Variable type:</b> "  + data[ 1 ];
            document.getElementById("dlgedit_varpersistance").innerHTML = "<b>Persistent:</b> "  + data[ 2 ];
            $('#dlgEditVariable').modal();
        };

        ///////////////////////////////////////////////////////////////////////////////////////////
        // setServerResult
        //
        // Get results from slect server modal

        function setServerResult() 
        {            
            // Save server data
            settings.url =  $('#modal-url').val();
            settings.user =  $('#modal-user').val();
            settings.password =  $('#modal-password').val();
            settings.authdomain = $('#modal-authdomain').val();

            vscp.admin.setStatus( settings.url, false );

            // Should we save persistent
            if ( $('#modal-brememberme').prop('checked') ) {
                
                 if ( typeof( Storage ) !== "undefined" ) {
                    localStorage.setItem( "vscp-url", $('#modal-url').val() );
                    localStorage.setItem( "vscp-user", $('#modal-user').val() );
                    localStorage.setItem( "vscp-password", $('#modal-password').val() );
                    localStorage.setItem( "vscp-authdomain", $('#modal-authdomain').val() );
                 }
            }

            doConnect();

        };

        ///////////////////////////////////////////////////////////////////////////////////////////
        // doConnect
        //
        // Connect to the VSCP daemon
        //

        function doConnect() 
        {

            var deferred = new $.Deferred();

            // Connect to VSCP server
            vscpConn.connect({

                url: settings.url,
                userName: settings.user,
                password: settings.password,
                vscptoken: settings.vscptoken,                                                                

                onSuccess: function( conn ) {
                    setConnectInfo( settings.url, true );
                    deferred.resolve();                    
                },

                onError: function( conn ) {
                    setConnectInfo( settings.url, false );
                    BootstrapDialog.alert( "Connection lost. Please reload website." );
                    deferred.reject();
                }
                
            });
            
            deferred.promise();
        };

        ///////////////////////////////////////////////////////////////////////////////////////////
        // doDisconnect
        //
        // Disconnect from the VSCP daemon
        //

        function doDisconnect() {
            vscpConn.disconnect();
            setConnectInfo( settings.url, false );
        };

        ///////////////////////////////////////////////////////////////////////////////////////////
        // ui enable/disable
        //
        // User interface data
        //

        var ui = {

            enable: function() {
                $( "#ui :input" ).attr( "disabled", false );
            },

            disable: function() {
                $( "#ui :input" ).attr( "disabled", true );
            }
        };

        ///////////////////////////////////////////////////////////////////////////////////////////
        // fetchVariables
        //

        function fetchVariables() {

                waitingDialog.show('Fetching variables...');

                ui.disable();

                var localregex = $("#myRegExp").val();

                // Clear table
                table.clear().draw();                

                vscpConn.listVar({

                    regex: $("#myRegExp").val(),

                    onVariable: function( conn, variable ) {
                        
                        table.row.add( [
                                variable.name.toLowerCase(), 
                                vscp.getVarTypeName( variable.type ), 
                                variable.persistency ? "true" : "false", 
                                variable.userid, 
                                variable.accessright.toString(16), 
                                variable.lastchange
                            ] ).draw( true );  
                         //waitingDialog.progress( 90 );                                    
                    },

                    onSuccess: function( conn ) {
                        ui.enable();
                    },

                    onError: function( conn ) {
                        ui.enable();
                    }
                });

                waitingDialog.hide();

            };

    </script>

</head>
<body>
   
    <!-- Menu -->
    <nav class="navbar navbar-default">
        <div class="container-fluid">
            <div class="navbar-header">
                <a class="navbar-brand" href="index.html">
                <img src="../images/logo/vscp_new.png" class="img-thumbnail" width="120" alt="vscp logo" /></a>
            </div>
            <div id="menu">
            </div>
        </div>
    </nav>

    <!-- **********************************************************************************************************************-->
    <!--                                              Progress dialog                                                          -->
    <!-- **********************************************************************************************************************-->
    <div class="modal fade" id="dlgProgress" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h1>Processing...</h1>
                </div>
                <div class="modal-body">
                    <div class="progress">
                        <div class="progress-bar progress-bar-success progress-bar-striped" role="progressbar" aria-valuenow="40" aria-valuemin="0" aria-valuemax="100" style="width: 40%">
                            <span class="sr-only">40% Complete (success)</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- **********************************************************************************************************************-->
    <!--                                            Modal to edit variable                                                     -->
    <!-- **********************************************************************************************************************-->
    <div id="dlgEditVariable" class="modal fade" role="dialog">
        
        <div class="modal-dialog">

            <!-- Modal content-->
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                    <h4 class="modal-title">Edit VSCP remote variable</h4>
                </div>
                <div class="modal-body">
                    <p id="">Variablepersistence</p>
                    <form role="form">
                        <div class="form-group">
                            <label for="server"><span class="glyphicon glyphicon-user"></span> Variable name</label>
                            <input type="text" class="form-control" id="dlgedit_varname" readonly >
                        </div>
                        <div class="form-group">
                            <label for="username"><span class="glyphicon glyphicon-user"></span> Variable type</label>
                            <input type="text" class="form-control" id="dlgedit_vartype" readonly >
                        </div>
                        <div class="checkbox">
                            <label><input type="checkbox" id="dlgedit_varpersistance" readonly value="true" checked >Variable persistency</label>
                        </div>
                        <div class="form-group">
                            <label for="password"><span class="glyphicon glyphicon-eye-open"></span> Password</label>
                            <input type="text" class="form-control" id="modal-password" placeholder="Enter password">
                        </div>
                        <div class="form-group">
                            <label for="authdomain"><span class="glyphicon glyphicon-eye-open"></span> Domain</label>
                            <input type="text" class="form-control" id="modal-authdomain" placeholder="Enter auth domain">
                        </div>
                        <div class="checkbox">
                            <label><input type="checkbox" id="modal-brememberme" value="true" checked>Remember me</label>
                        </div>

                        <!--
                        <button type="submit" class="btn btn-default btn-success btn-block" data-dismiss><span class="glyphicon glyphicon-off"></span>Connect</button>
                        -->
                        
                    </form>
                </div>
                <div class="modal-footer">  
                    <button type="button" class="btn btn-success btn-lg" data-dismiss="modal" onclick="setServerResult()">Open</button>                  
                    <button type="button" class="btn btn-primary btn-lg" data-dismiss="modal">Close</button>
                </div>
            </div>

        </div>

    </div>


    <div class="container-fluid">
        <h1>VSCP remote variables</h1>

        <div class="container-fluid">            
            <div class="row">
                
            </div>
            <div class="row">                
                <div class="col-sm-2">
                    
                    <div class="input-group">
                        <label for="basic-url">Select variables</label>
                    </div>

                    <div class="input-group"> 
                        <span class="input-group-addon" id="basic-addon1">:</span>
                        <input id="myRegExp" type="text" class="form-control" placeholder="regexp" aria-describedby="basic-addon1" >           
                    </div>
                    <p>
                    <div class="input-group col-sm-8">
                        <button type="button" class="btn btn-primary col-sm-12" onclick="fetchVariables();">
                            <span class="glyphicon glyphicon-repeat" aria-hidden="true"></span> Fetch variables
                        </button>
                    </div>
                    </p>
                    <div class="input-group col-sm-8">
                        <button type="button" class="btn btn-success col-sm-12" onclick="editDialog();">
                            <span class="glyphicon glyphicon-plus" aria-hidden="true"></span> Add variables
                        </button>
                    </div>

                </div>
                
                <div class="col-sm-9">
                    <table id="variableTable"  class="table table-striped select table-bordered table-hover display nowrap" cellspacing="50" width="100%"></table>
                </div>
                <div class="col-sm-1"></div>
            </div>

            <div class="row">
                <div class="col-sm-2"></div>                
                <div class="col-sm-9">
                    <b>Value:</b>
                    <pre id="idVariableValue"> </pre>
                </div>         
                <div class="col-sm-1"></div>
            </div> 

            <div class="row">
                <div class="col-sm-2"></div>                
                <div class="col-sm-9">
                    <b>Note:</b>
                    <pre id="idVariableNote"> </pre>
                </div>         
                <div class="col-sm-1"></div>
            </div>   
            
        </div>
        
    </div>
    
    <!-- <div id="copyright-info" /> -->

    <footer>
        <div id="status-footer"/>
    </footer>
    
    
    
</body>
</html>
