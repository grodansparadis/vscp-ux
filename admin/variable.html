<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>VSCP admin interface - Variable maintenance</title>

    <!-- Don't cache the page -->
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="-1" />

    <!-- JQuery -->
    <script type="text/javascript" src="../js/jquery/3.1.1/jquery-3.1.1.min.js"></script>

    <!-- Tether -->
    <script type="text/javascript" src="../js/tether/1.3.3/js/tether.min.js"></script>
    
    <!-- Bootstrap -->
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="../js/bootstrap/3.3.7/css/bootstrap.min.css"> 
    <script type="text/javascript" src="../js/bootstrap/3.3.7/js/bootstrap.min.js"></script>

    <!-- Bootstrap dialogs -->
    <link rel="stylesheet" href="../js/bootstrap3-dialog/1.34.6/css/bootstrap-dialog.min.css">
    <script type="text/javascript" src="../js/bootstrap3-dialog/1.34.6/js/bootstrap-dialog.min.js"></script>

    <!-- Bootstrap waitingfor dialog -->
    <script type="text/javascript" src="../js/waitingfor.js"></script>

    <!-- Data tables -->
    <link rel="stylesheet" href="../js/datatables/datatables.min.css">
    <script type="text/javascript" src="../js/datatables/datatables.min.js"></script>

    <script src="../js/ace/src-noconflict/ace.js" type="text/javascript" charset="utf-8"></script>

    <!-- Favorite icon -->
    <link rel="icon" href="favicon.ico">

    <!-- VSCP settings -->
    <script type="text/javascript" src="../js/settings.js"></script>
    <!-- VSCP hash calculation -->
    <script type="text/javascript" src="../js/md5.js"></script>
    <!-- VSCP websocket bases library -->
    <script type="text/javascript" src="../js/vscp.js"></script>
    <!-- VSCP admin library -->
    <script type="text/javascript" src="../js/vscpadmin.js"></script>
    <!-- VSCP user library -->
    <script type="text/javascript" src="../js/vscpuser.js"></script>

    <!-- Menu styles -->
    <link rel="stylesheet" type="text/css" href="css/menu.css">
    
    <!-- Boostrap navigation bar helper functions -->
    <script type="text/javascript" src="../js/navBar.js"></script>
    <!-- Navigation bar menu structure -->
    <script type="text/javascript" src="js/menu.js"></script>

    <link rel="stylesheet" type="text/css" href="css/vscp-admin.css">

    <script type="text/javascript">

        var curSelectedVariable;    // Current selected variable
        var table = null;  
        var gindexes;               // Curret selected row(s)
        var editorValue;            // ace editor for value
        var editorNote;             // ace editor for notes 

        // VSCP websocket connection
        var vscpConn = null;

        ///////////////////////////////////////////////////////////////////////////////////////////
        // load ready
        //
        // Wait until the whole website is loaded
        $( document ).ready( function() {

            // Fill types into dropdown
            vscp.constants.arrTypeNames.forEach( function(u) {
                // Add to edit type drop down
                $("#dlgedit_typedd").append("<li><a href=\"javascript:$('#dlgedit_type').val('"
                                                    + u + "');\">" + u + "</a></li>");
                // Add to add type drop down
                $("#dlgadd_typedd").append("<li><a href=\"javascript:$('#dlgadd_type').val('"
                                                    + u + "');\">" + u + "</a></li>");                                                    
            });
                
            // Show navigation bar menu
            navBarMenu.show( "menu", navBarMenu.content );

            // add command to all new editor instances
            /*
            ace.require("ace/commands/default_commands").commands.push({
                name: "Toggle Fullscreen",
                bindKey: "F11",
                exec: function( editor ) {
                    var fullScreen = dom.toggleCssClass( document.body, "fullScreen" )
                    dom.setCssClass( editor.container, "fullScreen", fullScreen )
                    editor.setAutoScrollEditorIntoView( !fullScreen )
                    editor.resize()
                }
            }); */
           

            // Value editor
            editorValue = ace.edit("editorValue");

            editorValue.on('change', function( e ) {
                //alert('change');
            });

            editorValue.commands.addCommand(
                {
                    name: 'Save',
                    bindKey: {win: 'Ctrl-S',  mac: 'Command-S'},
                    exec: function( editorValue ) {

                        ui.disable();
                        vscpConn.writeVar({

                            name:   curSelectedVariable[0],
                            type:   curSelectedVariable[6],
                            value:  editorValue.getSession().getValue(),

                            onSuccess: function( conn ) {
                                ui.enable();
                            },

                            onError: function( conn ) {
                                BootstrapDialog.alert({
                                    type: BootstrapDialog.TYPE_WARNING,
                                    message: 'Failed to save variable!'
                                });                                
                                ui.enable();
                            }

                        });
                    },
                    readOnly: true // false if this command should not apply in readOnly mode
                }
            );

            editorValue.commands.addCommand(
                {
                    name: 'Read again',
                    bindKey: {win: 'Ctrl-R',  mac: 'Command-R'},
                    exec: function( editorValue ) {

                        var table = $('#variableTable').DataTable();
                        var rows = table.rows( '.selected' ).data()
                        var data = rows[0]; // .Split(',');

                        vscpConn.readVar( {

                            name: data[ 0 ],
                            type: data[ 6 ],

                            onSuccess: function( conn, msg ) {
                                editorValue.setValue( msg.value );
                                editorValue.clearSelection();
                                editorValue.selection.moveTo(0, 0);
                                editorValue.getSession().setMode("ace/mode/" + 
                                vscp.getEditorModeFromType( msg.type ));
                                editorValue.$blockScrolling = Infinity;

                                editorNote.setValue( msg.note );
                                editorNote.clearSelection();
                                editorNote.selection.moveTo(0, 0);
                        
                                ui.enable();
                            },

                            onError: function( conn ) {
                                editorValue.setValue( "Failed to fetch value" );
                                editorValue.setValue( "Failed to fetch note" );
                                ui.enable();
                            }
                        });
                    },
                    readOnly: true // false if this command should not apply in readOnly mode
                }
            );

            editorValue.commands.addCommand(
                {
                    name: 'Increase size for editor window',
                    bindKey: {win: 'Ctrl-.',  mac: 'Command-.'},
                    exec: function( editorValue ) {
                        $('#editorValue').height( "500px");
                        editorValue.resize(true);
                    },
                    readOnly: true // false if this command should not apply in readOnly mode
                }
            );

            editorValue.commands.addCommand(
                {
                    name: 'Decrease size for editor window',
                    bindKey: {win: 'Ctrl-,',  mac: 'Command-,'},
                    exec: function( editorValue ) {
                        $('#editorValue').height( "100px");                     
                        editorValue.resize(true);
                    },
                    readOnly: true // false if this command should not apply in readOnly mode
                }
            );

            //editorValue.setTheme("ace/theme/iplastic");
            editorValue.setTheme("ace/theme/solarized_light");
            editorValue.getSession().setMode("ace/mode/javascript");
            editorValue.$blockScrolling = Infinity;
            editorValue.setReadOnly(false);  // false to make it editable
            editorValue.setShowPrintMargin(false);
            editorValue.getSession().setNewLineMode("unix");
            editorValue.setFontSize(16);
            editorValue.setAutoScrollEditorIntoView(true);

            $('#editorValue').height("100px");
            //$('#editorValue-section').height( "100px");

            // This call is required for the editor to fix all of
            // its inner structure for adapting to a change in size
            editorValue.resize(true);

            // Note editor
            editorNote = ace.edit("editorNote");

            editorNote.commands.addCommand(
                {
                    name: 'Save',
                    bindKey: {win: 'Ctrl-S',  mac: 'Command-S'},
                    exec: function( editorNote ) {

                        ui.disable();

                        vscpConn.createVar({

                            name:           curSelectedVariable[0],
                            value:          editorValue.getSession().getValue(),
                            note:           editorNote.getSession().getValue(),
                            type:           curSelectedVariable[6], 
                            accessrights:   curSelectedVariable[4],
                            persistency:    curSelectedVariable[2],

                            onSuccess: function( conn ) {
                                ui.enable();
                            },

                            onError: function( conn ) {
                                BootstrapDialog.alert({
                                    type: BootstrapDialog.TYPE_WARNING,
                                    message: 'Failed to save variable!'
                                });
                                ui.enable();
                            }

                        });
                    },
                    readOnly: true // false if this command should not apply in readOnly mode
                }
            );

            editorNote.commands.addCommand(
                {
                    name: 'Increase size for note window',
                    bindKey: {win: 'Ctrl-.',  mac: 'Command-.'},
                    exec: function( editorNote ) {
                        $('#editorNote').height( "500px");
                        editorNote.resize(true);
                    },
                    readOnly: true // false if this command should not apply in readOnly mode
                }
            );

            editorNote.commands.addCommand(
                {
                    name: 'Decrease size for note window',
                    bindKey: {win: 'Ctrl-,',  mac: 'Command-,'},
                    exec: function( editorNote ) {
                        $('#editorNote').height( "100px");
                        editorNote.resize(true);
                    },
                    readOnly: true // false if this command should not apply in readOnly mode
                }
            );

            //editorNote.setTheme("ace/theme/iplastic");
            editorNote.setTheme("ace/theme/solarized_light"); 
            editorNote.getSession().setMode("ace/mode/html");
            editorNote.$blockScrolling = Infinity;
            editorNote.setReadOnly(false);  // false to make it editable
            editorNote.setShowPrintMargin(false);
            editorNote.setFontSize(16);
            editorNote.getSession().setNewLineMode("unix");
            editorNote.setAutoScrollEditorIntoView(true);

            $('#editorNote').height( "100px");
            $('#editorNote-section').height( "100px");

            // This call is required for the editor to fix all of
            // its inner structure for adapting to a change in size
            editorNote.resize(true);

            //vscp.admin.setCopyright();
            vscp.admin.setStatus( "<b>Server:</b> no server selected.", false );

            if ( typeof( Storage ) !== "undefined" ) {
                // Server
                if ( null != localStorage.getItem("vscp-url") ) {
                    settings.url = localStorage.getItem("vscp-url");
                }

                vscp.admin.setStatus( settings.url, false );

                // User
                if ( null != localStorage.getItem("vscp-user") ) {
                    settings.user = localStorage.getItem("vscp-user");
                }
                // Password
                if ( null != localStorage.getItem("vscp-password") ) {
                    settings.password = localStorage.getItem("vscp-password");
                }
                // AuthDomain
                if ( null != localStorage.getItem("vscp-authdomain") ) {
                    settings.authdomain = localStorage.getItem("vscp-authdomain");
                }
            } 
            else {
                // No Web Storage support.
                vscp.admin.setStatus( settings.url, false );
            }   

            table = $('#variableTable').DataTable( {
                select: 'single',
                "order": [[ 1, 'asc' ], [ 2, 'asc' ]],
                "lengthChange": true,
                "lengthMenu": [[10, 25, 50, -1], [10, 25, 50, "All"]],
                dom: 'lBfrtip',
                "oTableTools": {
                    "sRowSelect": "single"
                },
                buttons: [
                    'colvis','copy', 'csv','excel', 'pdf','print'
                ],             
                columns: [
                    { title: "Name" },
                    { title: "Type" },
                    { title: "Persistent" },
                    { title: "Owner" },
                    { title: "Permission" },
                    { title: "lastchange" },
                    { title: "TypeId", visible: false, searchable: false  },
                    { title: "OwnerId", visible: false, searchable: false },
                    /*
                    {
                        "targets": -1,
                        data: null,
                        width : "5%",
                        defaultContent: '<span id="rowedit" class="glyphicon glyphicon-edit"> </span> <span id="rowdelete" class="glyphicon glyphicon-remove"> </span>',
                        orderable: false
                    },
                    */                
                ],
                
            });

            ///////////////////////////////////////////////////////////////////////////////////////////////
            // select row
            //

            table.on( 'select', function ( e, dt, type, indexes ) {
                
                if ( type === 'row' ) {

                    console.log('select');
                    gindexes = indexes;
                    var row = table.rows( indexes ).data(); //.pluck( 'id' );
                    var data = row[0]; 

                    curSelectedVariable = data;

                    vscpConn.readVar({

                        name: data[ 0 ],    // name
                        type: data[ 6 ],    // id for type

                        onSuccess: function( conn, msg ) {
                            editorValue.setValue( msg.value );
                            editorValue.clearSelection();
                            editorValue.selection.moveTo(0, 0);
                            editorValue.getSession().setMode("ace/mode/" + 
                                                                vscp.getEditorModeFromType( msg.type ));

                            editorNote.setValue( msg.note );
                            editorNote.clearSelection();
                            editorNote.selection.moveTo(0, 0);
                        
                            ui.enable();
                        },

                        onError: function( conn ) {
                            editorValue.setValue( "Failed to fetch value" );
                            editorNote.setValue( "Failed to fetch note" );
                            ui.enable();
                        }
                    });
                }
                
            });

            ///////////////////////////////////////////////////////////////////////////////////////////////
            // deselect row
            //

            table.on( 'deselect', function ( e, dt, type, indexes ) {
                if ( type === 'row' ) {
                    console.log('deselect');
                    editorValue.setValue( "" );
                    editorNote.setValue( "" );
                }
            });
 
            ///////////////////////////////////////////////////////////////////////////////////////////////
            // Double click row
            //
            
            $('#variableTable tbody').on( 'dblclick', 'tr', function () {

                //$(this).parents('tr') .addClass('selected');
                //console.log('dbl-click');

                vscpConn.readVar({

                        name: curSelectedVariable[ 0 ],    // name
                        type: curSelectedVariable[ 6 ],    // id for type

                        onSuccess: function( conn, msg ) {

                            editorValue.setValue( msg.value );
                            editorValue.clearSelection();
                            editorValue.selection.moveTo(0, 0);
                            editorValue.getSession().setMode("ace/mode/" + 
                                                                vscp.getEditorModeFromType( msg.type ));

                            editorNote.setValue( msg.note );
                            editorNote.clearSelection();
                            editorNote.selection.moveTo(0, 0);
                        
                            ui.enable();

                            editVariable();
                        },

                        onError: function( conn ) {
                            editorValue.setValue( "Failed to fetch value" );
                            editorNote.setValue( "Failed to fetch note" );
                            ui.enable();
                        }
                });
                            
            });

            ///////////////////////////////////////////////////////////////////////////////////////////////
            // Single click row
            //
            
            /*$('#variableTable tbody').on( 'click', 'tr', function () {
                //console.log("Single click");
            });*/

            
            ///////////////////////////////////////////////////////////////////////////////////////////////
            // rowedit click
            //

            /*$('#variableTable tbody').on( 'click', '#rowedit', function () {
                var data = table.row( $(this).parents('tr') ).data();
                $(this).parents('tr') .addClass('selected');
                showEditDialog();
            });*/

            ///////////////////////////////////////////////////////////////////////////////////////////////
            // rowdelete click
            //

            /*$('#variableTable tbody').on( 'click', '#rowdelete', function () {
                var data = table.row( $(this).parents('tr') ).data();
                //$(this).addClass('selected');
                alert( 'Delete ' + data[0]  );
            });*/
        
            ///////////////////////////////////////////////////////////////////////////////////////////////
            // Credential handling
            //

            if ( typeof( Storage ) !== "undefined" ) {

                // Server
                if ( null != localStorage.getItem("vscp-url") ) {                    
                    settings.url = localStorage.getItem("vscp-url");
                }

                vscp.admin.setStatus( settings.url, false );

                // User
                if ( null != localStorage.getItem("vscp-user") ) {
                    settings.user = localStorage.getItem("vscp-user");
                }
                // Password
                if ( null != localStorage.getItem("vscp-password") ) {
                    settings.password = localStorage.getItem("vscp-password");
                }
                // AuthDoamin
                if ( null != localStorage.getItem("vscp-token") ) {
                    settings.token = localStorage.getItem("vscp-token");
                }
            } 
            else {
                // No Web Storage support.
                //setConnectInfo( settings.url, false );
            }

            // Create a VSCP websocket
            vscpConn = new vscp.Connection();

            ui.disable();

            // Connect to VSCP server
            vscpConn.connect({

                url: settings.url,
                userName: settings.user,
                password: settings.password,
                authdomain: settings.authdomain,

                onSuccess: function( conn ) {

                    // Start receiving VSCP events
                    vscpConn.start({

                        onSuccess: function( conn ) {

                            // Show conect status
                            vscp.admin.setStatus( vscpConn.url, true );

                            fetchUsers();                       
                        },

                        onError: function( conn ) {

                            // Show connect status
                            vscp.admin.setStatus( vscpConn.url, false );

                            // Warn user
                            BootstrapDialog.alert({
                                title: 'ERROR',
                                type: BootstrapDialog.TYPE_DANGER,
                                message: 'Unable to connect to server.'
                            });

                            // Enable the user interface
                            ui.enable();

                        },

                        onConnError: function( conn ) {

                            // Show connect status
                            vscp.admin.setStatus( vscpConn.url, false );

                            // Warn user
                            BootstrapDialog.alert({
                                type: BootstrapDialog.TYPE_WARNING,
                                message: 'Connection error.'
                            });
                            
                            // Enable the user interface
                            ui.enable();
                        },

                    });

                },

                onError: function( conn ) {
                    BootstrapDialog.alert({
                        message: 'Could not establish a connection or connection lost. Reload page to try again.'
                    });
                    /*setTimeout(function () {
                        location.reload()
                    }, 2000);*/
                }

            });       

        }); // onLoad

        ///////////////////////////////////////////////////////////////////////////////////////////
        // ui enable/disable
        //
        // User interface data
        //

        var ui = {
            enable: function() {
                $( "#ui :input" ).attr( "disabled", false );
            },

            disable: function() {
                $( "#ui :input" ).attr( "disabled", true );
            }
        };

        ///////////////////////////////////////////////////////////////////////////////////////////
        // fetchVariables
        //

        function fetchUsers() {

            waitingDialog.show('Fetching users and variables...', {dialogSize: 'xm', progressType: 'warning'});
            //$('#myPleaseWait').modal('show');
            
            // Fetch users
            vscp.user.fetchUsers( function() {

                    // Enable the user interface
                    ui.enable();

                    // Fill drop downs with user data
                    vscp.user.fillUserDropdown("#dlgedit_userdd", "#dlgedit_owner" );
                    $('#dlgedit_userbtn').prop('disabled', true);   // Disable dropdown button
                    vscp.user.fillUserDropdown("#dlgadd_userdd", "#dlgadd_owner");
                    $('#dlgadd_userbtn').prop('disabled', true);   // Disable dropdown button

                    // Load variables
                    fetchVariables();
                                    
                },
                function() {
                                    
                    // Enable the user interface
                    ui.enable();

                    // Warn user
                    BootstrapDialog.alert({
                        title: 'ERROR',
                        type: BootstrapDialog.TYPE_DANGER,
                        message: 'Unable to  get users.'
                    });
                }
            );     
        }

        ///////////////////////////////////////////////////////////////////////////////////////////
        // fetchVariables
        //

        function fetchVariables() {

            editorValue.setValue("");
            editorNote.setValue("");

            ui.disable();

            var localregex = $("#myRegExp").val();

            // Clear table
            table.clear().draw();                

            vscpConn.listVar({

                regex: $("#myRegExp").val(),

                onVariable: function( conn, variable ) {
                        
                    table.row.add( [
                                variable.name.toLowerCase(), 
                                vscp.getVarTypeName( variable.type ), 
                                variable.persistency ? "true" : "false", 
                                vscp.user.getUserFromId( variable.userid ), 
                                variable.accessright.toString(16), 
                                variable.lastchange.substring(0,10) + " " + variable.lastchange.substring(11),
                                variable.type,
                                variable.userid
                            ] ).draw( false );  

                },

                onSuccess: function( conn ) {

                    ui.enable();                    
                    waitingDialog.hide();

                    // Select first row
                    table.row( 0 ).select();

                },

                onError: function( conn ) {
                    ui.enable();
                    waitingDialog.hide();
                }

            });

        };

        ///////////////////////////////////////////////////////////////////////////////////////////
        // deleteVariable
        //

        function deleteVariable() 
        {
            var table = $('#variableTable').DataTable();
            var data = table.rows('.selected').data();

            if ( undefined == data[0] ) {
                BootstrapDialog.alert({
                    title: 'WARNING',
                    type: BootstrapDialog.TYPE_WARNING,
                    message: 'A row must be selected for a variable to be deleted'
                });
                return;
            }

            var name =  data[0][0];

            if ( name.startsWith("vscp.")  ) {
                BootstrapDialog.alert({
                    title: 'WARNING',
                    type: BootstrapDialog.TYPE_WARNING,
                    message: 'A stock variable can not be deleted'
                });
                return;
            }


            BootstrapDialog.confirm( { 
                title: 'WARNING',
                message: 'Are you sure that the variable \'' + name + '\' should be deleted?', 
                type: BootstrapDialog.TYPE_WARNING, // <-- Default value is BootstrapDialog.TYPE_PRIMARY
                callback: function( result ) {
                    if ( result ) {
                        editorValue.setValue("");
                        editorNote.setValue("");

                        ui.disable();
                        vscpConn.removeVar({

                            name:   name,

                            onSuccess: function( conn ) {
                                table.row('.selected').remove().draw( false );
                                ui.enable();
                            },

                            onError: function( conn ) {
                                BootstrapDialog.alert({
                                    title: 'ERROR',
                                    type: BootstrapDialog.TYPE_WARNING,
                                    message: 'Failed to delete variable!'
                                });
                                ui.enable();
                            }

                        });
                    }
                }
            });
        };

        

        ///////////////////////////////////////////////////////////////////////////////////////////
        // editVariable
        //
        // Show the edit dialog
        //

        function editVariable() 
        {
            var table = $('#variableTable').DataTable();
            var data = table.rows('.selected').data();

            if ( undefined == data[0] ) {
                BootstrapDialog.alert({
                    title: 'WARNING',
                    type: BootstrapDialog.TYPE_WARNING,
                    message: 'A row must be selected for a variable to be edited'
                });
                return;
            }

            editDialog( data[0] );
        }
        
        ///////////////////////////////////////////////////////////////////////////////////////////
        // editDialog
        //
        // Show modal to edit variable
        //

        function editDialog( data ) 
        {
            // Can not change stock variables
            if ( data[ 0 ].startsWith("vscp.")  ) {
                $('#dlgedit_permission').prop('readonly', true);
                $('#dlgedit_note').prop('readonly', true);
            }
            else {
                $('#dlgedit_permission').prop('readonly', false);
                $('#dlgedit_note').prop('readonly', false);
            }

            $('#dlgedit_name').val( data[ 0 ] );
            $('#dlgedit_type').val( data[ 1 ] );
            $('#dlgedit_persistent').val( data[ 2 ] );
            $('#dlgedit_owner').val( data[ 3 ] );
            $('#dlgedit_permission').val( data[ 4 ] );

            var evmain = ace.edit("editorValue");
            var enmain = ace.edit("editorNote");

            $('#dlgedit_value').val( evmain.getValue() );
            $('#dlgedit_note').val( enmain.getValue() );
 
            $('#dlgEditVariable').modal();
        };

        ///////////////////////////////////////////////////////////////////////////////////////////
        // saveEditResult
        //
        // Save results from edit dialog
        //

        var saveEditResult = function() {

            var evmain = ace.edit("editorValue");
            var enmain = ace.edit("editorNote");

            evmain.setValue( $('#dlgedit_value').val() );
            evmain.clearSelection();

            enmain.setValue( $('#dlgedit_note').val() );
            enmain.clearSelection();

            vscpConn.createVar({

                name:           curSelectedVariable[0],
                value:          $('#dlgedit_value').val(),
                note:           $('#dlgedit_note').val(),
                type:           vscp.getVarTypeNumerical( $('#dlgedit_type').val() ).toString(), 
                accessrights:   parseInt( $('#dlgedit_permission').val(), 16).toString(),
                persistency:    $('#dlgedit_persistent').is(":checked") ? "true" : "false",

                onSuccess: function( conn ) {

                    // Read back the variable
                    vscpConn.readVar({

                        name: curSelectedVariable[0],                                           // name
                        type: vscp.getVarTypeNumerical( $('#dlgedit_type').val() ).toString(),  // id for type

                        onSuccess: function( conn, msg ) {

                            var row_exist;
                            if ( ( row_exist = isVariableInTable( msg.name ) ) < 0 ) {
                                // Add new row to table
                                table.row.add( [
                                    msg.name.toLowerCase(), 
                                    vscp.getVarTypeName( msg.type ), 
                                    msg.persistency ? "true" : "false", 
                                    vscp.user.getUserFromId( msg.userid ), 
                                    msg.accessright.toString(16), 
                                    msg.lastchange,
                                    msg.type,
                                    msg.userid
                                ] ).draw( false );  
                            }
                            else {
                                // Update row data
                                table.cell( row_exist, 1).data( vscp.getVarTypeName( msg.type ) );
                                table.cell( row_exist, 2).data( msg.persistency ? "true" : "false" );
                                table.cell( row_exist, 3).data( vscp.user.getUserFromId( msg.userid ) );
                                table.cell( row_exist, 4).data( msg.accessright.toString(16) );
                                table.cell( row_exist, 6).data( msg.type );
                                table.cell( row_exist, 7).data( msg.userid );
                            }
                        
                            ui.enable();

                        },

                        onError: function( conn ) {
                            ui.enable();
                        }
                    });

                    ui.enable();
                },

                onError: function( conn ) {
                    BootstrapDialog.alert({
                        title: 'ERROR',
                        type: BootstrapDialog.TYPE_DANGER,
                        message: 'Failed to save variable!'
                    });
                    ui.enable();
                }

            });

        };

        ///////////////////////////////////////////////////////////////////////////////////////////
        // duplicateVariable
        //
        // Duplicate selected variable
        //

        function duplicateVariable() 
        {
            var table = $('#variableTable').DataTable();
            //var data = $('#variableTable').dataTable({bRetrieve: true}).fnGetData(0)[0];
            var row = table.rows('.selected').data();            

            if ( undefined == row[0] ) {
                BootstrapDialog.alert({
                    title: 'WARNING',
                    type: BootstrapDialog.TYPE_WARNING,
                    message: 'A row must be selected for a variable to be duplicated'
                });
                return;
            }

            var data = row[0];
            
            $('#dlgadd_name').val( data[0] + "_new" );                        
            $('#dlgadd_type').val( data[1] );
            if ( data[2] == "true" ) {
                $('#dlgadd_persistent').prop('checked', true );
            }
            else {
                $('#dlgadd_persistent').prop('checked', false );
            }
            $('#dlgadd_owner').val( data[3] );
            $('#dlgadd_permission').val( data[4] );

            var evmain = ace.edit("editorValue");
            var enmain = ace.edit("editorNote");

            $('#dlgadd_value').val( evmain.getValue() );
            $('#dlgadd_note').val( enmain.getValue() );
 
            $('#dlgAddVariable').modal();

        };

        //////////////////////////////////////////////////////////////////////////////////////////
        // addVariable
        //

        function addVariable() 
        {
            var table = $('#variableTable').DataTable();

            //var data = table.rows('.selected').data();
            var data = $('#variableTable').dataTable({bRetrieve: true}).fnGetData(0)[0];
            

            addDialog();
        }

        

        ///////////////////////////////////////////////////////////////////////////////////////////
        // addDialog
        //
        // Show modal for adding data
        //

        function addDialog() 
        {
            $('#dlgadd_owner').val( vscpConn.userName );
            $('#dlgadd_permission').val( '744' );
            $('#dlgadd_type').val( 'String' );

            var evmain = ace.edit("editorValue");
            var enmain = ace.edit("editorNote");

            $('#dlgadd_value').val( "" );
            $('#dlgadd_note').val( "" );
 
            $('#dlgAddVariable').modal();

        };

        

        ///////////////////////////////////////////////////////////////////////////////////////////
        // isVariableInTable
        //

        function isVariableInTable( name ) {
            
            for ( i=0; i<table.rows().count(); i++ ) {
                
                if ( name.toLowerCase() == $('#variableTable').dataTable({bRetrieve: true}).fnGetData(i)[0]  ) {
                    return i;
                }
            }

            // Not found
            return -1;
        }

        ///////////////////////////////////////////////////////////////////////////////////////////
        // saveAddResult
        //
        // Save results from edit dialog
        //

        var saveAddResult = function() {

            // Not allowed to add varables with stock variable reserved names
            if ( $('#dlgadd_name').val().startsWith("vscp.")  ) {
                BootstrapDialog.alert({
                        title: 'ERROR',
                        type: BootstrapDialog.TYPE_DANGER,
                        message: 'Can\'t add varables that have names that start with \'vscp.\'. Reserved for stock variables.'
                    });
            }

            var accessrights = parseInt( $('#dlgadd_permission').val(), 16 );

            vscpConn.createVar({

                name:           $('#dlgadd_name').val(),
                value:          $('#dlgadd_value').val(),
                note:           $('#dlgadd_note').val(),
                type:           vscp.getVarTypeNumerical( $('#dlgadd_type').val() ).toString(), 
                user:           $('#dlgadd_user').val(),
                accessrights:   accessrights.toString(),
                persistency:    $('#dlgadd_persistent').is(":checked") ? "true" : "false",

                onSuccess: function( conn ) {
                    
                    // Read back the variable
                    vscpConn.readVar({

                        name: $('#dlgadd_name').val(),                                          // name
                        type: vscp.getVarTypeNumerical( $('#dlgadd_type').val() ).toString(),   // id for type

                        onSuccess: function( conn, msg ) {

                            var row_exist;
                            if ( ( row_exist = isVariableInTable( msg.name ) ) < 0 ) {
                                // Add new row to table
                                table.row.add( [
                                    msg.name.toLowerCase(), 
                                    vscp.getVarTypeName( msg.type ), 
                                    msg.persistency ? "true" : "false", 
                                    vscp.user.getUserFromId( msg.userid ), 
                                    msg.accessright.toString(16), 
                                    msg.lastchange,
                                    msg.type,
                                    msg.userid
                                ] ).draw( false );  
                            }
                            else {
                                // Update row data

                            }
                        
                            ui.enable();

                        },

                        onError: function( conn ) {
                            ui.enable();
                        }
                    });

                },

                onError: function( conn ) {
                    BootstrapDialog.alert({
                        title: 'ERROR',
                        type: BootstrapDialog.TYPE_DANGER,
                        message: 'Failed to save variable!'
                    });
                    ui.enable();
                }

            });

        };


    </script>

</head>
<body>

    <!-- **************************************************************************************-->
    <!--                              Modal to edit variable                                   -->
    <!-- **************************************************************************************-->
    <div id="dlgEditVariable" class="modal fade" role="dialog">
        
        <div class="modal-dialog">

            <!-- Modal content-->
            <div class="modal-content">
                
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                    <h4 class="modal-title">Edit VSCP remote variable</h4>
                </div>

                <div class="modal-body">
   
                    <form role="form">

                        <div class="form-group">
                            <label for="name"><span class="glyphicon glyphicon-asterisk"></span> name</label>
                            <input type="text" class="form-control" id="dlgedit_name" readonly >
                            <span class="help-block">Name of variable. Can not be changed.</span>
                        </div>

                        <div class="form-group">
                            <label for="dlgtype"><span class="glyphicon glyphicon-asterisk"></span> type</label>                    
                            <div class="input-group">                                
                                <input readonly type="text" class="form-control" aria-label="..." id="dlgedit_type">
                                <div class="input-group-btn">
                                    <button type="button" class="btn btn-success dropdown-toggle" 
                                                data-toggle="dropdown" aria-haspopup="true" 
                                                aria-expanded="false">types <span class="caret"></span></button>
                                    <ul id="dlgedit_typedd" class="dropdown-menu dropdown-menu-right">
                                    </ul>
                                </div>
                            </div>
                            <span class="help-block">Set variable type.</span>
                        </div>


                        <div class="form-group">
                            <label for="persistent"><span class="glyphicon glyphicon-asterisk"></span> persistence</label>
                            <input type="text" class="form-control" id="dlgedit_persistent" readonly >
                            <span class="help-block">Variable persistance. Can not be changed.</span>
                        </div>
                        
                        <div class="form-group">
                            <label for="owner"><span class="glyphicon glyphicon-asterisk"></span> owner</label>                    
                            <div class="input-group">                                
                                <input readonly type="text" class="form-control" aria-label="..." id="dlgedit_owner">
                                <div class="input-group-btn">
                                    <button type="button" class="btn btn-success dropdown-toggle" 
                                                id="dlgedit_userbtn"
                                                data-toggle="dropdown" aria-haspopup="true" 
                                                aria-expanded="false">users <span class="caret"></span></button>
                                    <ul id="dlgedit_userdd" class="dropdown-menu dropdown-menu-right">
                                    </ul>
                                </div>
                            </div>
                            <span class="help-block">Owner of variable is logged in user. Can not be changed.</span>
                        </div>
                        
                        <div class="form-group">
                            <label for="permission"><span class="glyphicon glyphicon-asterisk"></span> permission</label>
                            <input type="text" class="form-control" id="dlgedit_permission" placeholder="Enter permissions">
                            <span class="help-block">Set permissions for the variable. Permissions are given as tre hex numbers one each for user/group and others. Each of the digits is three bits for read, write and execute.</span>
                        </div>

                        <div class="form-group">
                            <label for="value"><span class="glyphicon glyphicon-asterisk"></span> value</label>
                            <textarea class="form-control" rows="6" id="dlgedit_value" placeholder="Enter value"></textarea>
                            <span class="help-block">Enter the value for the variable. May be easier to edit in the mainscreen editor</span>
                        </div>

                        <div class="form-group">
                            <label for="note"><span class="glyphicon glyphicon-asterisk"></span> note</label>
                            <textarea class="form-control" rows="6" id="dlgedit_note" placeholder="Enter value"></textarea>
                            <span class="help-block">Enter an optional description for the variable. Presented as HTML. May be easier to edit in the mainscreen editor</span>
                        </div>
                        
                    </form>
                </div>
                <div class="modal-footer">  
                    <button type="button" class="btn btn-success btn-lg" data-dismiss="modal" onclick="saveEditResult()">Save</button>                  
                    <button type="button" class="btn btn-primary btn-lg" data-dismiss="modal">Cancel</button>
                </div>
            </div>

        </div>

    </div>


    <!-- **************************************************************************************-->
    <!--                              Modal to add variable                                   -->
    <!-- **************************************************************************************-->
    <div id="dlgAddVariable" class="modal fade" role="dialog">
        
        <div class="modal-dialog">

            <!-- Modal content-->
            <div class="modal-content">
                
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                    <h4 class="modal-title">Add VSCP remote variable</h4>
                </div>

                <div class="modal-body">
   
                    <form role="form">

                        <div class="form-group">
                            <label for="name"><span class="glyphicon glyphicon-asterisk"></span> name</label>
                            <input type="text" class="form-control" id="dlgadd_name"  >
                            <span class="help-block">Enter name for variable. Must be unique.</span>
                        </div>

                        <div class="form-group">
                            <label for="dlgtype"><span class="glyphicon glyphicon-asterisk"></span> type</label>                    
                            <div class="input-group">                                
                                <input readonly type="text" class="form-control" aria-label="..." id="dlgadd_type">
                                <div class="input-group-btn">
                                    <button type="button" class="btn btn-success dropdown-toggle" 
                                                data-toggle="dropdown" aria-haspopup="true" 
                                                aria-expanded="false">types <span class="caret"></span></button>
                                    <ul id="dlgadd_typedd" class="dropdown-menu dropdown-menu-right">
                                    </ul>
                                </div>
                            </div>
                            <span class="help-block">Set variable type.</span>
                        </div>    

                        <div class="form-group">    
                            <div class="checkbox">
                                <label><input type="checkbox" id="dlgadd_persistent" value="true" checked ><b>Persistent</b></label>
                                <span class="help-block">Persistent variables are saved in a database, non persistent variables are saved in memory.</span>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="owner"><span class="glyphicon glyphicon-asterisk"></span> owner</label>                    
                            <div class="input-group">                                
                                <input readonly type="text" class="form-control" aria-label="..." id="dlgadd_owner">
                                <div class="input-group-btn">
                                    <button type="button" class="btn btn-success dropdown-toggle" 
                                                id="dlgadd_userbtn"
                                                data-toggle="dropdown" aria-haspopup="true" 
                                                aria-expanded="false">users <span class="caret"></span></button>
                                    <ul id="dlgadd_userdd" class="dropdown-menu dropdown-menu-right">
                                    </ul>
                                </div>
                            </div>
                            <span class="help-block">Set the owner of this variable.</span>
                        </div>
                        
                        <div class="form-group">
                            <label for="permission"><span class="glyphicon glyphicon-asterisk"></span> permission</label>
                            <input type="text" class="form-control" id="dlgadd_permission" placeholder="Enter permissions">
                            <span class="help-block">Set permissions for the variable. Permissions are given as tre hex numbers one each for user/group and others. Each of the digits is three bits for read, write and execute.</span>
                        </div>

                        <div class="form-group">
                            <label for="value"><span class="glyphicon glyphicon-asterisk"></span> value</label>
                            <textarea class="form-control" rows="6" id="dlgadd_value" placeholder="Enter value"></textarea>
                            <span class="help-block">Enter the value for the variable. May be easier to edit in the mainscreen editor</span>
                        </div>

                        <div class="form-group">
                            <label for="note"><span class="glyphicon glyphicon-asterisk"></span> note</label>
                            <textarea class="form-control" rows="6" id="dlgadd_note" placeholder="Enter note"></textarea>
                            <span class="help-block">Enter an optional description for the variable. Presented as HTML. May be easier to edit in the mainscreen editor</span>
                        </div>
                        
                    </form>
                </div>
                <div class="modal-footer">  
                    <button type="button" class="btn btn-success btn-lg" data-dismiss="modal" onclick="saveAddResult()">Add</button>                  
                    <button type="button" class="btn btn-primary btn-lg" data-dismiss="modal">Cancel</button>
                </div>
            </div>

        </div>

    </div>


    <!-- **********************************************************************************************************************-->
    <!--                                                      Menu                                                             -->
    <!-- **********************************************************************************************************************-->
    <nav class="navbar navbar-default">
        <div class="container-fluid">
            <div class="navbar-header">
                <a class="navbar-brand" href="index.html">
                <img src="../images/logo/vscp_new.png" class="img-thumbnail" width="120" alt="vscp logo" /></a>
            </div>
            <div id="menu">
            </div>
        </div>
    </nav>

    <!-- **********************************************************************************************************************-->
    <!--                                                    Table-area                                                        -->
    <!-- **********************************************************************************************************************-->
    <div class="container-fluid">
        <h1>VSCP remote variables</h1>

        <div class="container-fluid">            
            <div class="row">
                
            </div>
            <div class="row">                
                <div class="col-sm-2">
                    
                    <div class="input-group">
                        <label for="basic-url">Select variables</label>
                    </div>

                    <div class="input-group"> 
                        <span class="input-group-addon" id="basic-addon1">:</span>
                        <input id="myRegExp" type="text" class="form-control" placeholder="regexp" aria-describedby="basic-addon1" >         
                    </div>
                    <p>
                    <div class="input-group col-sm-8">
                        <button type="button" class="btn btn-primary col-sm-12" onclick="waitingDialog.show('Fetching variables...', {dialogSize: 'xm', progressType: 'warning'});fetchVariables();">
                            <span class="glyphicon glyphicon-repeat" aria-hidden="true"></span> Fetch variables
                        </button>
                    </div>
                    </p>

                    <p>
                    <div class="input-group col-sm-8">
                        <button type="button" class="btn btn-success col-sm-12" onclick="editVariable();">
                            <span class="glyphicon glyphicon-edit" aria-hidden="true"></span> Edit variable
                        </button>
                    </div>
                    </p>
                    
                    <p>
                    <div class="input-group col-sm-8">
                        <button type="button" class="btn btn-success col-sm-12" onclick="addVariable();">
                            <span class="glyphicon glyphicon-plus" aria-hidden="true"></span> Add variable
                        </button>
                    </div>
                    </p>

                    <p>
                    <div class="input-group col-sm-8">
                        <button type="button" class="btn btn-success col-sm-12" onclick="deleteVariable();">
                            <span class="glyphicon glyphicon-remove" aria-hidden="true"></span> Delete variable
                        </button>
                    </div>
                    </p>

                    <p>
                    <div class="input-group col-sm-8">
                        <button type="button" class="btn btn-success col-sm-12" onclick="duplicateVariable()">
                            <span class="glyphicon glyphicon-duplicate" aria-hidden="true"></span> Duplicate variable
                        </button>
                    </div>
                    </p>

                    <p>
                    <!--  TODO    
                    <div class="input-group col-sm-8">
                        <button type="button" class="btn btn-success col-sm-12" onclick="showTable();">
                            <span class="glyphicon glyphicon-cloud-upload" aria-hidden="true"></span> Import variables
                        </button>
                    </div>
                    </p>
                    -->        
                </div>
                
                <div class="col-sm-9">
                    <table id="variableTable"  class="table table-striped table-bordered table-hover display compact nowrap" cellspacing="50" width="100%"></table>
                </div>
                <div class="col-sm-1"></div>
            </div>

            <div class="row">
                <div class="col-sm-2"><b>Shortcut keys</b><br><b>ctrl+'S'</b> - Save variable<br><b>ctrl+'R'</b> - Read variable<br><b>ctrl+'.'</b> - Increase size<br><b>ctrl+','</b> - Decreas size<br></div>                
                <div class="col-sm-9">
                    <b>Value:</b>
                    <div class="ace-holder">
                        <div id="divval" class="ace-editor">
                            <div id="editorValue"></div>
                        </div>
                    </div>     
                </div>         
                <div class="col-sm-1"></div>
            </div>
            <br>
            <div class="row">
                <div class="col-sm-2"></div>                
                <div class="col-sm-9">
                    <b>Note:</b>
                    <div class="ace-holder">
                        <div class="ace-editor">
                            <div id="editorNote"></div>
                        </div>
                    </div>        
                </div>         
                <div class="col-sm-1"></div>
            </div>     

        </div>
        
    </div>
    
    <!-- <div id="copyright-info" /> -->

    <footer>
        <div id="status-footer"/>
    </footer>
    
</body>
</html>
