<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>VSCP admin interface - Variable maintenance</title>

    <!-- Don't cache the page -->
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="-1" />

    <!-- JQuery -->
    <script type="text/javascript" src="../js/jquery/3.1.1/jquery-3.1.1.min.js"></script>

    <!-- Tether -->
    <script type="text/javascript" src="../js/tether/1.3.3/js/tether.min.js"></script>
    
    <!-- Bootstrap -->
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="../js/bootstrap/3.3.7/css/bootstrap.min.css"> 
    <script type="text/javascript" src="../js/bootstrap/3.3.7/js/bootstrap.min.js"></script>

    <!-- Bootstrap dialogs -->
    <link rel="stylesheet" href="../js/bootstrap3-dialog/1.34.6/css/bootstrap-dialog.min.css">
    <script type="text/javascript" src="../js/bootstrap3-dialog/1.34.6/js/bootstrap-dialog.min.js"></script>

    <!-- Bootstrap waitingfor dialog -->
    <script type="text/javascript" src="../js/waitingfor.js"></script>

    <!-- Data tables -->
    <link rel="stylesheet" href="../js/datatables/datatables.min.css">
    <script type="text/javascript" src="../js/datatables/datatables.min.js"></script>

    <script src="../js/ace/src-noconflict/ace.js" type="text/javascript" charset="utf-8"></script>

    <!-- Favorite icon -->
    <link rel="icon" href="favicon.ico">

    <!-- VSCP settings -->
    <script type="text/javascript" src="../js/settings.js"></script>
    <!-- VSCP hash calculation -->
    <script type="text/javascript" src="../js/md5.js"></script>
    <!-- VSCP websocket bases library -->
    <script type="text/javascript" src="../js/vscp.js"></script>
    <!-- VSCP admin library -->
    <script type="text/javascript" src="../js/vscpadmin.js"></script>

    <!-- Menu styles -->
    <link rel="stylesheet" type="text/css" href="css/menu.css">
    
    <!-- Boostrap navigation bar helper functions -->
    <script type="text/javascript" src="../js/navBar.js"></script>
    <!-- Navigation bar menu structure -->
    <script type="text/javascript" src="js/menu.js"></script>

    <link rel="stylesheet" type="text/css" href="css/vscp-admin.css">

    <script type="text/javascript">

        var table = null;

        // VSCP websocket connection
        var vscpConn = null;

        ///////////////////////////////////////////////////////////////////////////////////////////
        // load ready
        //
        // Wait until the whole website is loaded
        $( document ).ready( function() {
                
            // Show navigation bar menu
            navBarMenu.show( "menu", navBarMenu.content );

            // add command to all new editor instaces
            /*
            require("ace/commands/default_commands").commands.push({
                name: "Toggle Fullscreen",
                bindKey: "F11",
                exec: function( editor ) {
                    var fullScreen = dom.toggleCssClass( document.body, "fullScreen" )
                    dom.setCssClass( editor.container, "fullScreen", fullScreen )
                    editor.setAutoScrollEditorIntoView( !fullScreen )
                    editor.resize()
                }
            }) */

            // Value editor
            var editorValue = ace.edit("editorValue");

            editorValue.commands.addCommand(
                {
                    name: 'Save',
                    bindKey: {win: 'Ctrl-S',  mac: 'Command-S'},
                    exec: function( editorValue ) {
                        alert("Now save this shit");
                    },
                    readOnly: true // false if this command should not apply in readOnly mode
                }
            );

            editorValue.commands.addCommand(
                {
                    name: 'Read again',
                    bindKey: {win: 'Ctrl-R',  mac: 'Command-R'},
                    exec: function( editorValue ) {
                        alert("Read again!");
                    },
                    readOnly: true // false if this command should not apply in readOnly mode
                }
            );

            editorValue.commands.addCommand(
                {
                    name: 'Increase size',
                    bindKey: {win: 'Ctrl-+',  mac: 'Command-+'},
                    exec: function( editorValue ) {
                        $('#editorValue').height( "500px");
                    },
                    readOnly: true // false if this command should not apply in readOnly mode
                }
            );

            editorValue.commands.addCommand(
                {
                    name: 'Decrease size',
                    bindKey: {win: 'Ctrl--',  mac: 'Command-.'},
                    exec: function( editorValue ) {
                        $('#editorValue').height( "100px");
                    },
                    readOnly: true // false if this command should not apply in readOnly mode
                }
            );

            //editorValue.setTheme("ace/theme/solarized_light");
            editorValue.setTheme("ace/theme/iplastic");
            //editorValue.setTheme("ace/theme/solarized_light"); 
            editorValue.getSession().setMode("ace/mode/javascript");
            //editorValue.setReadOnly(true);  // false to make it editable
            editorValue.setShowPrintMargin(false);

            $('#editorValue').height( "100px");
            $('#editorValue-section').height( "100px");

            // This call is required for the editor to fix all of
            // its inner structure for adapting to a change in size
            editorValue.resize();

            // Note editor
            var editorNote = ace.edit("editorNote");
            //editorValue.setTheme("ace/theme/solarized_light");
            editorNote.setTheme("ace/theme/iplastic");
            //editorValue.setTheme("ace/theme/solarized_light"); 
            editorNote.getSession().setMode("ace/mode/html");
            editorNote.setReadOnly(true);  // false to make it editable
            editorNote.setShowPrintMargin(false);

            $('#editorNote').height( "100px");
            $('#editorNote-section').height( "100px");

            // This call is required for the editor to fix all of
            // its inner structure for adapting to a change in size
            editorNote.resize();

            //vscp.admin.setCopyright();
            vscp.admin.setStatus( "<b>Server:</b> no server selected.", false );

            if ( typeof( Storage ) !== "undefined" ) {
                // Server
                if ( null != localStorage.getItem("vscp-url") ) {
                    settings.url = localStorage.getItem("vscp-url");
                }

                vscp.admin.setStatus( settings.url, false );

                // User
                if ( null != localStorage.getItem("vscp-user") ) {
                    settings.user = localStorage.getItem("vscp-user");
                }
                // Password
                if ( null != localStorage.getItem("vscp-password") ) {
                    settings.password = localStorage.getItem("vscp-password");
                }
                // AuthDomain
                if ( null != localStorage.getItem("vscp-authdomain") ) {
                    settings.authdomain = localStorage.getItem("vscp-authdomain");
                }
            } 
            else {
                // No Web Storage support.
                vscp.admin.setStatus( settings.url, false );
            }   

            table = $('#variableTable').DataTable( {
                select: 'single',
                dom: 'Bfrtip',
                buttons: [
                    'colvis','copy', 'csv','excel', 'pdf','print'
                ],
                columns: [
                    { title: "Name" },
                    { title: "Type" },
                    { title: "Persistent" },
                    { title: "Owner" },
                    { title: "Permission" },
                    { title: "lastchange" },
                    {
                        data: null,
                        width : "5%",
                        //defaultContent: '<a href="#" class="remove">Delete</a> <a href="#" class="edit">Edit</a>',
                        defaultContent: '<a href="javascript:void(0)" class="editor_edit" onclick="showEditDialog();"><span class="glyphicon glyphicon-edit"/></a> <a href="javascript:void(0)" class="editor_remove" onclick="editDialog();" ><span class="glyphicon glyphicon-remove"/></a>',
                        orderable: false
                    },                
                ],
                
            });
 
            // Double click row
            $('#variableTable tbody').on( 'dblclick', 'tr', function () {
                $(this).addClass('selected');
                var data = table.row( this ).data();
                editDialog( data );                
            });

            // Click row
            $('#variableTable tbody').on( 'click', 'tr', function () {
                
                $(this).addClass('selected');

                var data = table.row( this ).data();

                vscpConn.readVar({

                    name: data[ 0 ],

                    onSuccess: function( conn, msg ) {
                        ui.enable();
                        
                        editorValue.setValue( vscp.decodeValue( msg.type, msg.value ) );
                        editorValue.clearSelection();
                        editorNote.setValue( vscp.b64DecodeUnicode( msg.note ) );
                        editorNote.clearSelection();
                    },

                    onError: function( conn ) {
                        ui.enable();
                        document.getElementById("idVariableValue").innerHTML = "Failed to fetch value";
                        document.getElementById("idVariableNote").innerHTML = "";
                    }
                });

            });
 
            /*$('#button').click( function () {
                table.row('.selected').remove().draw( false );
             });      */       

            if ( typeof( Storage ) !== "undefined" ) {

                // Server
                if ( null != localStorage.getItem("vscp-url") ) {                    
                    settings.url = localStorage.getItem("vscp-url");
                }

                vscp.admin.setStatus( settings.url, false );

                // User
                if ( null != localStorage.getItem("vscp-user") ) {
                    settings.user = localStorage.getItem("vscp-user");
                }
                // Password
                if ( null != localStorage.getItem("vscp-password") ) {
                    settings.password = localStorage.getItem("vscp-password");
                }
                // AuthDoamin
                if ( null != localStorage.getItem("vscp-token") ) {
                    settings.token = localStorage.getItem("vscp-token");
                }
            } 
            else {
                // No Web Storage support.
                //setConnectInfo( settings.url, false );
            }

            // Create a VSCP websocket
            vscpConn = new vscp.Connection();

            // Connect to VSCP server
            vscpConn.connect({

                url: settings.url,
                userName: settings.user,
                password: settings.password,
                authdomain: settings.authdomain, 

                onSuccess: function( conn ) {

                    // Start receiving VSCP events
                    vscpConn.start({

                        onSuccess: function( conn ) {
                            vscp.admin.setStatus( settings.url, true );

                            // Fetch users
                            fetchUsers();
                            
                            // Load variables
                            fetchVariables();
                            
                            // Enable the user interface
                            ui.enable();
                        },

                        onError: function( conn ) {
                            vscp.admin.setStatus( settings.url, false );
                            alert("Unable to connect to server.");
                            ui.enable();
                        },

                        onConnError: function( conn ) {
                            vscp.admin.setStatus( settings.url, false );
                            ui.enable();
                        },

                    });

                },

                onError: function( conn ) {
                    alert("Couldn't establish a connection or connection lost.");
                }

            });       

        });

        function showEditDialog() 
        {
            var table = $('#variableTable').DataTable();
            var data = table.rows( '.selected' ).data();
            editDialog( data[0] );
        }
        
        ///////////////////////////////////////////////////////////////////////////////////////////
        // editDialog
        //
        // Show modal to select active server to use.
        //

        function editDialog( data ) 
        {
            // Not allowed to ed
            /*if ( data[ 0 ].startsWith("vscp.")  ) {
                return;
            }*/
            $('#dlgedit_varname').val( data[ 0 ] );
            $('#dlgedit_vartype').val( data[ 1 ] );
            $('#dlgedit_varpersistent').val( data[ 2 ] );
            $('#dlgedit_varowner').val( data[ 3 ] );
            $('#dlgedit_varpermission').val( data[ 4 ] );
            $('#dlgedit_varvalue').val( $("#idVariableValue").html() );
            $('#dlgedit_varnote').val( $("#idVariableNote").html() );
            /*
            $('#modal-brememberme').val( "false" );
            $('#dlgedit_varpersistance').checked = false;
            */
            $('#dlgEditVariable').modal();
        };

        ///////////////////////////////////////////////////////////////////////////////////////////
        // ui enable/disable
        //
        // User interface data
        //

        var ui = {

            enable: function() {
                $( "#ui :input" ).attr( "disabled", false );
            },

            disable: function() {
                $( "#ui :input" ).attr( "disabled", true );
            }
        };

        ///////////////////////////////////////////////////////////////////////////////////////////
        // fetchVariables
        //

        function fetchVariables() {

            waitingDialog.show('Fetching variables...');
            waitingDialog.progress( 0 );

            ui.disable();

            var localregex = $("#myRegExp").val();

            // Clear table
            table.clear().draw();                

            vscpConn.listVar({

                regex: $("#myRegExp").val(),

                onVariable: function( conn, variable ) {

                    waitingDialog.progress( variable.idx, variable.count );
                    console.log(" Progress" + variable.idx + " " + variable.count );
                        
                    table.row.add( [
                                variable.name.toLowerCase(), 
                                vscp.getVarTypeName( variable.type ), 
                                variable.persistency ? "true" : "false", 
                                variable.userid, 
                                variable.accessright.toString(16), 
                                variable.lastchange
                            ] ).draw( true );  

                },

                onSuccess: function( conn ) {
                    ui.enable();
                    waitingDialog.hide();
                },

                onError: function( conn ) {
                    ui.enable();
                    waitingDialog.hide();
                }

            });

        };

        ///////////////////////////////////////////////////////////////////////////////////////////
        // fetchUsers
        //

        function fetchUsers() {

            ui.disable();

            // Clear table
            table.clear().draw();                

            vscpConn.readVar({

                name: "vscp.user",

                onSuccess: function( conn, options ) {
                    ui.enable();
                    console.log( "value = " + vscp.b64DecodeUnicode( options.value ) + 
                                    " note = " + vscp.b64DecodeUnicode( options.note ) );
                },

                onError: function( conn ) {
                    ui.enable();
                }
                
            });

        };

    </script>

</head>
<body>

    <!-- **********************************************************************************************************************-->
    <!--                                            Modal to edit variable                                                     -->
    <!-- **********************************************************************************************************************-->
    <div id="dlgEditVariable" class="modal fade" role="dialog">
        
        <div class="modal-dialog">

            <!-- Modal content-->
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                    <h4 class="modal-title">Edit VSCP remote variable</h4>
                </div>
                <div class="modal-body">
   
                    <form role="form">
                        <div class="form-group">
                            <label for="name"><span class="glyphicon glyphicon-asterisk"></span> name</label>
                            <input type="text" class="form-control" id="dlgedit_varname" readonly >
                        </div>
                        <div class="form-group">
                            <label for="type"><span class="glyphicon glyphicon-asterisk"></span> type</label>
                            <input type="text" class="form-control" id="dlgedit_vartype" readonly >
                        </div>
                        <div class="form-group">
                            <label for="persistent"><span class="glyphicon glyphicon-asterisk"></span> persistence</label>
                            <input type="text" class="form-control" id="dlgedit_varpersistent" readonly >
                        </div>
                        <!--
                        <div class="checkbox">
                            <label><input type="checkbox" id="dlgedit_varpersistance" readonly value="true" checked >Persistent</label>
                        </div>
                        -->
                        <div class="form-group">
                            <label for="owner"><span class="glyphicon glyphicon-asterisk"></span> owner</label>
                            
                            <!--
                            <input type="text" class="form-control" id="dlgedit_varowner" placeholder="Enter owner">
                            -->
                            
                            <div class="input-group">                                
                                <input readonly type="text" class="form-control" aria-label="..." id="dlgedit_varowner">
                                <div class="input-group-btn">
                                    <button type="button" class="btn btn-success dropdown-toggle" 
                                                data-toggle="dropdown" aria-haspopup="true" 
                                                aria-expanded="false">users <span class="caret"></span></button>
                                    <ul class="dropdown-menu dropdown-menu-right">
                                        <li><a href="javascript:$('#dlgedit_varowner').val('admin');">Admin</a></li>
                                        <li><a href="javascript:$('#dlgedit_varowner').val('Curt');">Curt</a></li>
                                        <li><a href="javascript:$('#dlgedit_varowner').val('Andrea');">Andrea</a></li>
                                        <li role="separator" class="divider"></li>
                                        <li><a href="javascript:$('#dlgedit_varowner').val('Mr Magoo');">Mr Magoo</a></li>
                                    </ul>
                                </div>
                            </div>

                        </div>
                        
                        <div class="form-group">
                            <label for="permission"><span class="glyphicon glyphicon-asterisk"></span> permission</label>
                            <input type="text" class="form-control" id="dlgedit_varpermission" placeholder="Enter permissions">
                        </div>

                        <!--

                        <div class="form-group">
                            <label for="value"><span class="glyphicon glyphicon-asterisk"></span> value</label>
                            <input type="text" class="form-control" id="dlgedit_varvalue" placeholder="Enter value">
                        </div>

                        <div class="form-group">
                            <label for="note"><span class="glyphicon glyphicon-asterisk"></span> note</label>
                            <input type="text" class="form-control" id="dlgedit_varnote" placeholder="Enter note">
                        </div>
                        
                        <div class="checkbox">
                            <label><input type="checkbox" id="modal-brememberme" value="true" checked>Remember me</label>
                        </div>
                        
                        <button type="submit" class="btn btn-default btn-success btn-block" data-dismiss><span class="glyphicon glyphicon-off"></span>Connect</button>
                        -->
                        
                    </form>
                </div>
                <div class="modal-footer">  
                    <button type="button" class="btn btn-success btn-lg" data-dismiss="modal" onclick="_setServerResult()">Save</button>                  
                    <button type="button" class="btn btn-primary btn-lg" data-dismiss="modal">Close</button>
                </div>
            </div>

        </div>

    </div>

    <!-- **********************************************************************************************************************-->
    <!--                                                      Menu                                                             -->
    <!-- **********************************************************************************************************************-->
    <nav class="navbar navbar-default">
        <div class="container-fluid">
            <div class="navbar-header">
                <a class="navbar-brand" href="index.html">
                <img src="../images/logo/vscp_new.png" class="img-thumbnail" width="120" alt="vscp logo" /></a>
            </div>
            <div id="menu">
            </div>
        </div>
    </nav>

    <!-- **********************************************************************************************************************-->
    <!--                                                    Table-area                                                        -->
    <!-- **********************************************************************************************************************-->
    <div class="container-fluid">
        <h1>VSCP remote variables</h1>

        <div class="container-fluid">            
            <div class="row">
                
            </div>
            <div class="row">                
                <div class="col-sm-2">
                    
                    <div class="input-group">
                        <label for="basic-url">Select variables</label>
                    </div>

                    <div class="input-group"> 
                        <span class="input-group-addon" id="basic-addon1">:</span>
                        <input id="myRegExp" type="text" class="form-control" placeholder="regexp" aria-describedby="basic-addon1" >           
                    </div>
                    <p>
                    <div class="input-group col-sm-8">
                        <button type="button" class="btn btn-primary col-sm-12" onclick="fetchVariables();">
                            <span class="glyphicon glyphicon-repeat" aria-hidden="true"></span> Fetch variables
                        </button>
                    </div>
                    </p>

                    <p>
                    <div class="input-group col-sm-8">
                        <button type="button" class="btn btn-success col-sm-12" onclick="showEditDialog();">
                            <span class="glyphicon glyphicon-edit" aria-hidden="true"></span> Edit variable
                        </button>
                    </div>
                    </p>
                    
                    <p>
                    <div class="input-group col-sm-8">
                        <button type="button" class="btn btn-success col-sm-12" onclick="editDialog();">
                            <span class="glyphicon glyphicon-plus" aria-hidden="true"></span> Add variable
                        </button>
                    </div>
                    </p>

                    <p>
                    <div class="input-group col-sm-8">
                        <button type="button" class="btn btn-success col-sm-12" onclick="editDialog();">
                            <span class="glyphicon glyphicon-remove" aria-hidden="true"></span> Delete variable
                        </button>
                    </div>
                    </p>

                    <p>
                    <div class="input-group col-sm-8">
                        <button type="button" class="btn btn-success col-sm-12" onclick="hideTable()">
                            <span class="glyphicon glyphicon-duplicate" aria-hidden="true"></span> Duplicate variable
                        </button>
                    </div>
                    </p>

                    <p>
                    <div class="input-group col-sm-8">
                        <button type="button" class="btn btn-success col-sm-12" onclick="showTable();">
                            <span class="glyphicon glyphicon-cloud-upload" aria-hidden="true"></span> Import variables
                        </button>
                    </div>
                    </p>

                </div>
                
                <div class="col-sm-9">
                    <table id="variableTable"  class="table table-striped table-bordered table-hover display nowrap" cellspacing="50" width="100%"></table>
                </div>
                <div class="col-sm-1"></div>
            </div>

            <div class="row">
                <div class="col-sm-2"><b>Shortcut keys</b><br><b>ctrl+'S'</b> - Save variable<br><b>ctrl+'R'</b> - Read variable<br><b>ctrl+'+'</b> - Increase size<br><b>ctrl+'-'</b> - Decreas size<br></div>                
                <div class="col-sm-9">
                    <b>Value:</b>
                    <div id="editorValue">function foo(items) { var x = "This is a vale"; return x; }</div>
                </div>         
                <div class="col-sm-1"></div>
            </div>

            <div class="row">
                <div class="col-sm-2"></div>                
                <div class="col-sm-9">
                    <b>Note:</b>
                    <div id="editorNote">This is note</div>
                </div>         
                <div class="col-sm-1"></div>
            </div>     

        </div>
        
    </div>
    
    <!-- <div id="copyright-info" /> -->

    <footer>
        <div id="status-footer"/>
    </footer>
    
</body>
</html>
